<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Telegram</title>
    <style>
        /* 变量定义 */
        :root {
            --c-bg: #18222d;
            --c-bg-light: #212c37;
            --c-bg-lighter: #2a3542;
            --c-text: #ffffff;
            --c-text-light: #a3a3a3;
            --c-primary: #3390ec;
            --c-sent-bubble: #4f94f0;
            --c-received-bubble: var(--c-bg-lighter);
            --c-online: #4ade80;
            --c-offline: #71717a;
        }

        /* 基础与重置 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            overflow: hidden;
            height: 100vh;
        }

        /* 主体布局 */
        .app-container { display: none; height: 100vh; }
        .sidebar { width: 320px; min-width: 320px; background-color: var(--c-bg-light); border-right: 1px solid var(--c-bg-lighter); display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--c-bg); }

        /* 侧边栏头部 (Telegram风格) */
        .sidebar-header { padding: 10px 15px; }
        .search-container { position: relative; display: flex; align-items: center; }
        .menu-button { position: absolute; left: 0; top: 0; height: 100%; background: none; border: none; cursor: pointer; padding: 0 12px; display: flex; align-items: center; justify-content: center; z-index: 2; border-radius: 50%; }
        .menu-button:hover { background-color: rgba(255,255,255,0.1); }
        .search-bar { background-color: var(--c-bg); border: none; border-radius: 20px; padding: 10px 15px 10px 45px; width: 100%; color: var(--c-text); font-size: 14px; }
        .search-bar::placeholder { color: var(--c-text-light); }
        .search-bar:focus { outline: 1px solid var(--c-primary); }

        /* 会话列表与搜索结果 */
        .conversation-list-container { position: relative; flex-grow: 1; overflow: hidden; }
        .conversation-list { height: 100%; overflow-y: auto; }
        .search-results { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-bg-light); z-index: 100; overflow-y: auto; display: none; }
        .search-result-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; }
        .search-result-item:hover { background-color: var(--c-bg-lighter); }
        .conversation-item { position: relative; display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--c-bg); transition: background-color 0.2s; }
        .conversation-item:hover { background-color: var(--c-bg-lighter); }
        .conversation-item.active { background-color: var(--c-primary); }
        .avatar-container { position: relative; margin-right: 12px; flex-shrink: 0; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--c-primary); display: flex; align-items: center; justify-content: center; font-weight: 600; object-fit: cover; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--c-bg-light); background-color: var(--c-offline); }
        .status-dot.online { background-color: var(--c-online); }
        .conversation-details { flex-grow: 1; overflow: hidden; padding-right: 10px; }
        .conversation-meta { display: flex; flex-direction: column; align-items: flex-end; font-size: 12px; color: var(--c-text-light); }
        .unread-badge { background-color: var(--c-primary); color: white; font-size: 11px;font-weight: 600;min-width: 20px;height: 20px;border-radius: 10px;display: flex;align-items: center;justify-content: center;padding: 0 6px;margin-top: 6px; }
        .conversation-name { font-weight: 600; font-size: 15px; }
        .last-message-content { font-size: 14px; color: var(--c-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }

        /* 聊天区 */
        #chat-area { display: none; flex-grow: 1; flex-direction: column; height: 100%; position: relative; }
        .chat-header { display: flex; align-items: center; padding: 10px 20px; background-color: var(--c-bg-light); border-bottom: 1px solid var(--c-bg-lighter); flex-shrink: 0; }
        #chat-header-avatar { width: 40px; height: 40px; margin-right: 15px; }
        #chat-status { font-size: 13px; color: var(--c-primary-light); height: 18px; transition: color 0.3s ease; }
        .messages-window { flex-grow: 1; padding: 20px; overflow-y: auto; background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg'); background-size: contain; }
        .message-row { display: flex; margin-bottom: 4px; }
        .message-row.mine { justify-content: flex-end; }
        .message-bubble { max-width: 65%; padding: 8px 12px; border-radius: 18px; line-height: 1.45; word-break: break-word; display: flex; flex-direction: column; }
        .message-row.mine .message-bubble { background-color: var(--c-sent-bubble); border-bottom-right-radius: 4px; }
        .message-row.other .message-bubble { background-color: var(--c-received-bubble); border-bottom-left-radius: 4px; }
        .message-content img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .message-input-area { display: flex; align-items: center; padding: 10px 20px; background-color: var(--c-bg-light); flex-shrink: 0; }
        #message-content { flex-grow: 1; background-color: var(--c-bg); border: 1px solid var(--c-bg-lighter); border-radius: 20px; padding: 12px 20px; color: var(--c-text); font-size: 15px; text-align: left; }
        #message-content:focus { outline: none; border-color: var(--c-primary); }
        .input-button { background: none; border: none; cursor: pointer; padding: 10px; }
        .input-button svg { width: 24px; height: 24px; color: var(--c-text-light); }
        .send-button { background-color: var(--c-primary); border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px;}
        .message-timestamp { font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-top: 5px; align-self: flex-end; display: flex; align-items: center; }

        /* 弹窗与遮罩层 */
        .login-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .login-box {
            background-color: var(--c-bg-light);
            padding: 40px 35px;
            border-radius: 16px; /* 圆角更明显一些 */
            text-align: left; /* 【核心修改】文字左对齐，更专业 */
            width: 380px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); /* 增强阴影 */
            border: 1px solid var(--c-bg-lighter);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* 鼠标悬停时，让卡片轻微上浮，增加交互感 */
        .login-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        /* 标题样式 */
        .login-box h3 {
            margin-bottom: 15px; /* 减小一点标题和第一个输入框的间距 */
            font-weight: 600;
            font-size: 26px;
            color: var(--c-text);
            text-align: center; /* 标题居中 */
        }

        /* 【新增】为输入框增加一个外层标签，用于显示 "ID号", "密码" 文字 */
        .login-box .input-group {
            margin-bottom: 22px;
        }

        .login-box .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--c-text-light);
            font-size: 14px;
            font-weight: 500;
        }

        /* 输入框本身的新样式 */
        .login-box input {
            display: block;
            width: 100%;
            margin: 0; /* 移除旧的 margin */
            background-color: var(--c-bg);
            border: 1px solid var(--c-bg-lighter);
            border-radius: 8px;
            padding: 14px;
            color: var(--c-text);
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        /* 输入框聚焦（正在输入）时的样式 */
        .login-box input:focus {
            outline: none;
            border-color: var(--c-primary);
            box-shadow: 0 0 0 3px rgba(51, 144, 236, 0.25); /* 增加一个柔和的发光效果 */
        }

        /* 按钮的新样式 */
        .login-box button {
            width: 100%;
            border: none;
            border-radius: 8px;
            padding: 14px 20px;
            background: var(--c-primary);
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.2);
        }

        /* 按钮的鼠标悬停效果 */
        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 144, 236, 0.3);
            background: #459cff; /* 颜色变亮一点 */
        }

        /* “立即注册/登录”链接的样式 */
        .login-box p {
            text-align: center; /* 让这段文字居中 */
        }

        .login-box p a {
            color: var(--c-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .login-box p a:hover {
            text-decoration: underline;
        }

        #create-group-modal, #profile-modal { display: none; }
        .modal-box { width: 400px; text-align: left; }
        .modal-box h3 { margin-bottom: 20px; }
        .modal-box input, .modal-box textarea { width: 100%; text-align: left; background-color: var(--c-bg); border: 1px solid var(--c-bg-lighter); border-radius: 8px; padding: 12px; color: var(--c-text); margin-bottom: 15px; }
        #profile-bio { height: 80px; resize: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-actions button { border: none; border-radius: 8px; padding: 10px 20px; font-weight: 600; cursor: pointer; width: auto; }
        .modal-actions .btn-cancel { background-color: var(--c-bg-lighter); color: var(--c-text); }
        .modal-actions .btn-create { background-color: var(--c-primary); color: white; }

        /* 欢迎页面 */
        #welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; text-align: center; color: var(--c-text-light); }
        #welcome-screen svg { width: 80px; height: 80px; color: var(--c-bg-lighter); margin-bottom: 20px; }

        /* 滑动菜单 */
        .nav-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: var(--c-bg-light); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .nav-menu.open { transform: translateX(0); }
        .nav-menu-header { padding: 20px; background-color: var(--c-primary); cursor: pointer; }
        .nav-menu-header:hover { background-color: var(--c-primary-light); }
        .nav-menu-header .avatar { width: 60px; height: 60px; margin-bottom: 10px; background-color: white; color: var(--c-primary); }
        .nav-menu-header h4 { font-size: 18px; }
        .nav-menu-list { list-style: none; padding: 10px 0; }
        .nav-menu-list li { display: flex; align-items: center; padding: 15px 20px; cursor: pointer; }
        .nav-menu-list li:hover { background-color: var(--c-bg-lighter); }
        .nav-menu-list li svg { margin-right: 20px; color: var(--c-text-light); }
        #profile-avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 20px; border: 3px solid var(--c-bg-lighter); }
        #avatar-upload-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; background-color: var(--c-bg-lighter); color: var(--c-text); cursor: pointer; margin-bottom: 15px; }

        /* “无感”滚动条 */
        .messages-window::-webkit-scrollbar, .conversation-list::-webkit-scrollbar, .search-results::-webkit-scrollbar { width: 6px; }
        .messages-window::-webkit-scrollbar-track, .conversation-list::-webkit-scrollbar-track, .search-results::-webkit-scrollbar-track { background: transparent; }
        .messages-window::-webkit-scrollbar-thumb, .conversation-list::-webkit-scrollbar-thumb, .search-results::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 3px; }
        .messages-window:hover::-webkit-scrollbar-thumb, .conversation-list:hover::-webkit-scrollbar-thumb, .search-results:hover::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.25); }

        .message-status-icon { margin-left: 4px; font-weight: bold; color:rgba(255, 255, 255, 0.6); }
        .message-status-icon.read { color: var(--c-online); /* 已读后变为蓝色 */}
        .message-image-container { display: block; max-width: 300px; max-height: 400px; border-radius: 12px; overflow: hidden; cursor: pointer; background-color: var(--c-bg); aspect-ratio: 4 / 3; }
        .message-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .message-bubble:has(.message-image-container) { padding: 0; background-color: transparent; }
        .message-row:not(.mine) .reply-btn { margin-left: 8px; }
        .message-row.mine .reply-btn { margin-right: 8px; order: -1; }
        .reply-btn { opacity: 0; transition: opacity 0.2s; }
        .message-row:hover .reply-btn { opacity: 0.5; }
        .reply-btn:hover { opacity: 1 !important; }
        .message-bubble:has(.lottie-sticker) { background-color: transparent; padding: 0;}

        /* @提及 消息样式 */
        .mention { background-color: rgba(51, 144, 236, 0.3); color: #ffffff; font-weight: 600; padding: 1px 4px; border-radius: 4px;}
        /* @提及 弹出菜单样式 */
        #mentions-popup { position: absolute; bottom: 65px; left: 20px; width: 300px; background-color: var(--c-bg-lighter); border: 1px solid var(--c-bg-light);border-radius: 8px;max-height: 200px;overflow-y: auto;z-index: 20;}
        .mention-item {display: flex;align-items: center;padding: 8px 12px;cursor: pointer;}
        .mention-item:hover {background-color: var(--c-primary);}
        .mention-item .avatar {width: 30px;height: 30px;font-size: 14px;margin-right: 10px;}

        .theme-switch {position: relative;display: inline-block;width: 50px; /* 开关宽度 */height: 28px; /* 开关高度 */flex-shrink: 0;cursor: pointer;}
        .theme-switch input {opacity: 0;width: 0;height: 0;}
        .slider {position: absolute;top: 0;left: 0;right: 0;bottom: 0;background-color: var(--c-bg-lighter); /* 关闭时的背景色 */transition: .4s;}
        .slider:before {position: absolute;content: "";height: 20px; /* 圆点高度 */width: 20px; /* 圆点宽度 */left: 4px;bottom: 4px;background-color: white; /* 圆点颜色 */transition: .4s;}
        input:checked + .slider {background-color: var(--c-primary); /* 开启时的背景色 */}
        input:checked + .slider:before {transform: translateX(22px); /* 圆点移动距离 */}
        .slider.round {border-radius: 34px;}
        .slider.round:before {border-radius: 50%;}
        .nav-user-info {flex-grow: 1; /* 让这个元素占据所有剩余空间，把开关推到最右边 */}


        body.light-mode {--c-bg: #ffffff;--c-bg-light: #f0f2f5;--c-bg-lighter: #e4e6eb;--c-text: #050505;--c-text-light: #65676b;--c-sent-bubble: #0084ff;--c-received-bubble: #e4e6eb;--c-primary: #0084ff;}
        body.light-mode .message-row.other .message-bubble {color: #050505;}

        .profile-box {width: 380px;background-color: var(--c-bg-light);border-radius: 12px;overflow: hidden; /* 隐藏超出圆角的部分 */box-shadow: 0 10px 40px rgba(0,0,0,0.5);transform: scale(0.95);opacity: 0;transition: transform 0.3s ease, opacity 0.3s ease;}
        #user-profile-modal.visible .profile-box {transform: scale(1);opacity: 1;}
        .profile-header {height: 120px;background: linear-gradient(45deg, var(--c-primary), #5f99e4);}
        .profile-avatar-container {margin-top: -60px; /* 让头像一半在头部，一半在身体 */text-align: center;}
        #profile-page-avatar {width: 100px;height: 100px;border-radius: 50%;border: 4px solid var(--c-bg-light);object-fit: cover;}
        .profile-body {padding: 20px 30px 30px;text-align: center;}
        #profile-page-username {font-size: 24px;font-weight: 600;margin-bottom: 5px;}
        .profile-id {color: var(--c-text-light);font-size: 15px;margin-bottom: 15px;}
        .profile-bio {font-size: 15px;line-height: 1.5;color: var(--c-text);margin-bottom: 25px;min-height: 45px; /* 至少给简介一个高度 */}
        .profile-message-btn {width: 100%;padding: 12px;border: none;border-radius: 8px;background-color: var(--c-primary);color: white;font-size: 16px;font-weight: 600;cursor: pointer;transition: background-color 0.2s;}
        .profile-message-btn:hover {background-color: #459cff;}
    </style>
</head>
<body>
<div id="login-overlay" class="login-overlay">
    <div class="login-box">
        <h3>登录 Mini-Telegram</h3>
        <p id="login-error" style="color: #f87171; height: 20px; text-align: center;"></p>

        <div class="input-group">
            <label for="login-id">ID号</label>
            <input type="text" id="login-id" placeholder="请输入你的ID号">
        </div>

        <div class="input-group">
            <label for="login-password">密码</label>
            <input type="password" id="login-password" placeholder="请输入你的密码" onkeydown="if(event.key === 'Enter') login()">
        </div>

        <button onclick="login()" style="margin-top: 10px;">登 录</button>

        <p style="margin-top: 25px; font-size: 14px; color: var(--c-text-light);">
            没有账户？ <a href="#" onclick="showRegisterForm(event)">立即注册</a>
        </p>
    </div>
</div>

<div id="register-overlay" class="login-overlay" style="display: none;">
    <div class="login-box">
        <h3>注册新用户</h3>
        <p id="register-error" style="color: #f87171; height: 20px; text-align: center;"></p>
        <div class="input-group">
            <label for="register-username">昵称</label>
            <input type="text" id="register-username" placeholder="个性昵称">
        </div>
        <div class="input-group">
            <label for="register-id">ID号</label>
            <input type="text" id="register-id" placeholder="用于登录的唯一ID">
        </div>
        <div class="input-group">
            <label for="register-password">密码</label>
            <input type="password" id="register-password" placeholder="请输入密码">
        </div>
        <button onclick="register()" style="margin-top: 10px;">注 册</button>
        <p style="margin-top: 25px; font-size: 14px; color: var(--c-text-light);">
            已有账户？ <a href="#" onclick="showLoginForm(event)">立即登录</a>
        </p>
    </div>
</div>

<div id="create-group-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>创建新群组</h3>
        <input type="text" id="group-name" placeholder="群组名称">
        <input type="text" id="group-description" placeholder="群组描述（可选）">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCreateGroupModal()">取消</button>
            <button class="btn-create" onclick="handleCreateGroup()">创建</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>编辑个人资料</h3>
        <img id="profile-avatar-preview" alt="avatar">
        <button id="avatar-upload-btn" onclick="triggerAvatarUpload()">更换头像</button>

        <label for="profile-username" style="display:block; margin-top:15px;">昵称</label>
        <input type="text" id="profile-username" placeholder="设置你的昵称">

        <label for="profile-bio" style="display:block; margin-top:15px;">个人简介</label>
        <textarea id="profile-bio" placeholder="留下你的足迹..."></textarea>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeProfileModal()">取消</button>
            <button class="btn-create" onclick="handleUpdateProfile()">保存</button>
        </div>
    </div>
</div>

<div id="nav-menu-overlay" class="modal-overlay" style="display: none; z-index: 1000;" onclick="closeNavMenu()"></div>
<div id="nav-menu" class="nav-menu">
    <div class="nav-menu-header" onclick="openProfileModal()">
        <div id="nav-avatar" class="avatar"></div>
        <div class="nav-user-info">
            <h4 id="nav-username"></h4>
            <small id="nav-user-id" style="color: rgba(255,255,255,0.7); font-weight: 400;"></small>
        </div>
        <label class="theme-switch" for="theme-checkbox" title="切换深色/浅色模式" onclick="event.stopPropagation()">
            <input type="checkbox" id="theme-checkbox">
            <div class="slider round"></div>
        </label>
    </div>
    <ul class="nav-menu-list">
        <li onclick="openCreateGroupModal()">
            <svg fill="currentColor" width="24" height="24" viewBox="0 0 256 256"><path d="M168,128a12,12,0,0,1-12,12H132v24a12,12,0,0,1-24,0V140H84a12,12,0,0,1,0-24h24V92a12,12,0,0,1,24,0v24h24A12,12,0,0,1,168,128Zm80-40.75a12,12,0,0,1-7.1,11.07l-34.7,17.34.1,0L178.9,133a12,12,0,0,1-9,22.5h-1.5l-33.5-20.09.2.3a12,12,0,0,1-21.2,0l-.2-.3-33.5,20.09h-1.5a12,12,0,0,1-9-22.5l-27.4-17.15.1,0-34.7-17.34A12,12,0,0,1,8,87.25V72a12,12,0,0,1,12-12H236a12,12,0,0,1,12,12Z"></path></svg>
            <span>创建群组</span>
        </li>
    </ul>
</div>

<div id="view-members-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h3 id="view-members-title">群组成员</h3>
        <div id="members-list-container" style="max-height: 400px; overflow-y: auto;"></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeViewMembersModal()">关闭</button>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="search-container">
                <button class="menu-button" onclick="openNavMenu()">
                    <svg fill="var(--c-text-light)" width="24" height="24" viewBox="0 0 256 256"><path d="M224,128a12,12,0,0,1-12,12H44a12,12,0,0,1,0-24H212A12,12,0,0,1,224,128ZM44,76H212a12,12,0,0,0,0-24H44a12,12,0,0,0,0,24Zm168,104H44a12,12,0,0,0,0,24H212a12,12,0,0,0,0-24Z"></path></svg>
                </button>
                <input type="text" id="user-search-bar" class="search-bar" placeholder="搜索用户或群组" oninput="handleUserSearch(event)" onfocus="showSearchResults()" onblur="hideSearchResults()">
            </div>
        </div>
        <div class="conversation-list-container">
            <div id="conversation-list" class="conversation-list"></div>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    <div class="main-content">
        <div id="chat-area">
            <div class="chat-header">
                <div id="chat-header-avatar" class="avatar"></div>
                <div>
                    <h4 id="chat-title"></h4>
                    <small id="chat-status"></small>
                </div>
                <button id="add-member-btn" class="input-button" title="添加成员" style="margin-left: auto; display: none;">
                </button>
                <button id="view-members-btn" class="input-button" title="查看成员" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M176,144a12,12,0,0,1-12,12H92a12,12,0,0,1,0-24h72A12,12,0,0,1,176,144Zm-12-52a12,12,0,0,0-12-12H92a12,12,0,0,0,0,24h60A12,12,0,0,0,164,92Zm44,36A104,104,0,1,1,104,24,104.11,104.11,0,0,1,208,128ZM104,40a88,88,0,1,0,88,88A88.1,88.1,0,0,0,104,40Z"></path></svg>
                </button>
            </div>
            <div id="messages-window" class="messages-window"></div>
            <div id="mentions-popup" style="display: none;"></div>
            <div class="message-input-area">
                <button class="input-button" onclick="triggerFileUpload()" title="上传文件">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M165.27,133.27a12,12,0,0,1-17,0L116,100.94V192a12,12,0,0,1-24,0V100.94L59.73,133.27a12,12,0,0,1-17-17l52-52a12,12,0,0,1,17,0l52,52A12,12,0,0,1,165.27,133.27ZM236,132a12,12,0,0,1-12,12H188a12,12,0,0,1,0-24h36V80H32v32H68a12,12,0,0,1,0,24H32a12,12,0,0,1-12-12V80A12,12,0,0,1,32,68H224a12,12,0,0,1,12,12Z"></path></svg>
                </button>

                <div id="emoji-wrapper" style="position: relative;">
                    <button id="emoji-btn" class="input-button" title="选择表情">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-32-48a12,12,0,1,1,12,12A12,12,0,0,1,96,168Zm80,0a12,12,0,1,1,12,12A12,12,0,0,1,176,168Zm-4-58.42a12,12,0,0,1,12-10.27,64.12,64.12,0,0,1,48,48,12,12,0,0,1-22.26,8.84,40,40,0,0,0-71.48,0,12,12,0,1,1-22.26-8.84,64.12,64.12,0,0,1,48-48A12,12,0,0,1,172,99.58Z"></path></svg>
                    </button>
                    <div id="emoji-panel" style="display: none; position: absolute; bottom: 50px; left: 0px; z-index: 10; width: 400px; max-height: 250px; overflow-y: auto; background-color: var(--c-bg-light); border: 1px solid var(--c-bg-lighter); border-radius: 8px; padding: 10px; box-shadow: 0 -5px 10px rgba(0,0,0,0.2); grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 8px;">
                    </div>
                </div>

                <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(event)">
                <input type="file" id="avatar-file-input" style="display: none;" onchange="handleAvatarUpload(event)" accept="image/*">
                <input type="text" id="message-content" placeholder="输入消息..." onkeydown="handleKeydown(event)" oninput="handleTyping()">
                <button class="send-button" onclick="sendMessage()" title="发送消息">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256"><path d="M240,12.28a15.82,15.82,0,0,0-15.68-4L12.37,88.45a16,16,0,0,0,2.5,29.74l63.26,24.81,21.28,56.28A16,16,0,0,0,116,211.72a15.86,15.86,0,0,0,12.55-6.08l80-212A16,16,0,0,0,240,12.28ZM117.7,196.28l-21.27-56.28L176,84Z"></path></svg>
                </button>
            </div>
        </div>

        <div id="welcome-screen">
            <svg width="80" height="80" fill="var(--c-bg-lighter)" viewBox="0 0 256 256"><path d="M128,24A104,104,0,0,0,36.18,176.88L24.83,210.93a16,16,0,0,0,20.24,20.24l34.05-11.35A104,104,0,1,0,128,24Zm0,192a88,88,0,0,1-45.15-13.16L38.3,221.7a8,8,0,0,1-10-10L46.84,167.15A88,88,0,1,1,128,216Z"></path></svg>
            <p style="color: var(--c-text-light); margin-top: 20px;">请从左侧选择一个会话开始聊天</p>
        </div>
    </div>
</div>

<div id="user-profile-modal" class="modal-overlay" style="display: none;" onclick="closeUserProfileModal()">
    <div class="profile-box" onclick="event.stopPropagation()">
        <div class="profile-header">
        </div>
        <div class="profile-avatar-container">
            <img id="profile-page-avatar" src="" alt="avatar">
        </div>
        <div class="profile-body">
            <h3 id="profile-page-username"></h3>
            <p class="profile-id" id="profile-page-custom-id"></p>
            <p class="profile-bio" id="profile-page-bio"></p>
            <button class="profile-message-btn" onclick="startChatFromProfile()">发消息</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<script>
    // 立即执行函数，用于初始化主题
    (function() {
        const themeCheckbox = document.getElementById('theme-checkbox');
        const body = document.body;
        // 1. 页面加载时，检查本地存储，应用之前的主题
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'light') {
            body.classList.add('light-mode');
            themeCheckbox.checked = true;
        }
        // 2. 为开关添加点击事件
        themeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light'); // 保存偏好到本地
            } else {
                body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark'); // 保存偏好到本地
            }
        });
    })();
    const GATEWAY_URL = 'http://localhost:8888';
    let stompClient = null;
    let currentUser = {id: null, username: null};
    let currentChat = {id: null, type: null, name: null};
    const userCache = {};
    let statusUpdateInterval = null;
    const activeSubscriptions = {};
    let typingTimeout = null;
    let searchDebounceTimeout = null;
    let isCurrentUserGroupOwner = false;
    let lastMessageTimestamp = null;
    let viewingProfileUserId = null;
    // --- 辅助函数 ---
    function handleKeydown(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
    function triggerFileUpload() { document.getElementById('file-input').click(); }
    function triggerAvatarUpload() { document.getElementById('avatar-file-input').click(); }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert("认证信息不存在或已过期，请重新登录。");
            window.location.reload();
            return Promise.reject("No token found");
        }
        const defaultHeaders = { 'Authorization': `Bearer ${token}` };
        if (!(options.body instanceof FormData)) {
            defaultHeaders['Content-Type'] = 'application/json';
        }
        const finalHeaders = { ...defaultHeaders, ...options.headers };
        const finalOptions = { ...options, headers: finalHeaders };
        return fetch(url, finalOptions);
    }

    function showRegisterForm(event) {
        event.preventDefault(); // 阻止 a 标签的默认跳转行为
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('register-overlay').style.display = 'flex';
    }

    function showLoginForm(event) {
        event.preventDefault();
        document.getElementById('register-overlay').style.display = 'none';
        document.getElementById('login-overlay').style.display = 'flex';
    }

    async function register() {
        // 1. 获取注册表单中的所有输入值
        const username = document.getElementById('register-username').value.trim();
        const customId = document.getElementById('register-id').value.trim();
        const password = document.getElementById('register-password').value.trim();
        const errorEl = document.getElementById('register-error');

        // 【【核心修改】】安全地获取 email 的值
        const emailInput = document.getElementById('register-email');
        // 如果 email 输入框存在，就获取它的值；如果不存在，则默认为一个空字符串
        const email = emailInput ? emailInput.value.trim() : "";

        // 2. 简单的前端校验
        if (!username || !customId || !password) {
            errorEl.innerText = '昵称、ID号和密码不能为空！';
            return;
        }
        errorEl.innerText = '';

        // 3. 构造发送到后端的请求体
        const registrationRequest = { username, customId, password, email };

        try {
            // 4. 调用后端的注册接口
            const response = await fetch(`${GATEWAY_URL}/api/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(registrationRequest)
            });

            // 5. 处理后端的响应
            if (response.ok) {
                alert('注册成功！现在可以用你的ID号登录了。');
                showLoginForm(new Event('click')); // 注册成功后自动跳转回登录界面
            } else {
                // 如果后端返回错误（比如ID已存在），显示错误信息
                const errorMessage = await response.text();
                errorEl.innerText = errorMessage;
            }
        } catch (error) {
            console.error('注册时发生网络错误:', error);
            errorEl.innerText = '发生网络错误，请稍后再试。';
        }
    }
    // --- 核心认证与连接 ---
    async function login() {
        const username = document.getElementById('login-id').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!username || !password) {
            errorEl.innerText = '请输入用户名和密码！';
            return;
        }
        errorEl.innerText = '';
        try {
            const response = await fetch(`${GATEWAY_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password })
            });
            if (!response.ok) throw new Error('ID号或密码错误！');
            const data = await response.json();
            localStorage.setItem('jwt_token', data.jwt);
            currentUser = { id: data.userId, username: data.username };

            const profileResponse = await fetchWithAuth(`${GATEWAY_URL}/api/users/${currentUser.id}`);
            if (!profileResponse.ok) throw new Error('获取用户个人资料失败');
            const fullUserProfile = await profileResponse.json();

            userCache[currentUser.id] = fullUserProfile;

            connectWebSocket();
        } catch (error) {
            errorEl.innerText = error.message;
        }
    }

    function connectWebSocket() {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            console.error("无法连接WebSocket：缺少JWT token");
            return;
        }

        const headers = { 'userId': currentUser.id };
        const socket = new SockJS(`${GATEWAY_URL}/ws?token=${token}`);
        stompClient = Stomp.over(socket);

        stompClient.connect(headers, frame => {
            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';

            loadAndRenderConversations();

            stompClient.subscribe('/user/queue/profile-updates', message => {
                const updatedUser = JSON.parse(message.body);
                handleUserUpdate(updatedUser);
            });

            stompClient.subscribe('/user/queue/status', message => {
                const statusUpdate = JSON.parse(message.body);
                const iconEl = document.getElementById(`status-icon-${statusUpdate.messageId}`);
                if (iconEl && statusUpdate.status === 'READ') {
                    iconEl.innerHTML = '✓✓';
                    iconEl.style.color = '#4ade80';
                    iconEl.className = 'message-status-icon read';
                }
            });

            // --- 【【核心修改在这里】】 ---
            // 1. 只订阅私聊消息队列。这是永久订阅。
            stompClient.subscribe(`/user/${currentUser.id}/queue/messages`, message => {
                const parsedMsg = JSON.parse(message.body);

                // 2. 更新左侧列表（现在对所有私聊消息都生效）
                const isChatting = currentChat.id && currentChat.type === 'PRIVATE' && (parsedMsg.senderId == currentChat.id || parsedMsg.recipientId == currentChat.id);
                updateConversationListRealtime(parsedMsg, isChatting);

                // 3. 如果正在当前窗口聊天，则显示消息
                if (isChatting) {
                    showMessage(parsedMsg);
                }
            });
        });
    }
    function updateConversationListRealtime(message, isChatting) {
        const list = document.getElementById('conversation-list');
        if (!list) return;

        // 确定这个消息对应的会话ID (私聊是对方ID，群聊是群ID)
        const conversationId = message.messageType === 'GROUP' ? message.groupId : (message.senderId == currentUser.id ? message.recipientId : message.senderId);

        // 查找列表中是否已存在这个会话
        let convoItem = list.querySelector(`.conversation-item[data-chat-id='${conversationId}']`);

        // 如果会话不存在 (这是一个全新的会话)
        if (!convoItem) {
            // 重新加载整个列表来显示新会话 (这是最简单可靠的方式)
            loadAndRenderConversations();
            return;
        }

        // 如果会话已存在，则更新它
        // a. 更新最后一条消息内容和时间
        const lastMsgEl = convoItem.querySelector('.last-message-content');
        const timeEl = convoItem.querySelector('.conversation-meta span');

        if (lastMsgEl) {
            lastMsgEl.innerHTML = formatLastMessage(message.content); // 使用我们之前写的格式化函数
        }
        if (timeEl && message.timestamp) {
            timeEl.innerText = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // b. 更新未读数 (只有当不是当前聊天时才增加)
        if (!isChatting) {
            const badgeEl = convoItem.querySelector('.unread-badge');
            if (badgeEl) {
                // 如果徽章已存在，增加数字
                badgeEl.innerText = parseInt(badgeEl.innerText) + 1;
            } else {
                // 如果徽章不存在，创建并插入它
                const newBadge = document.createElement('div');
                newBadge.className = 'unread-badge';
                newBadge.innerText = '1';
                convoItem.querySelector('.conversation-meta').appendChild(newBadge);
            }
        }

        // c. 将这个会话项移动到列表的最顶部
        if (list.firstChild !== convoItem) {
            list.prepend(convoItem);
        }
    }
    // --- 业务功能 ---
    async function loadAndRenderConversations() {
        try {
            // 1. 从后端获取所有会话的列表
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/messages/conversations`);
            if (!response.ok) {
                throw new Error(`获取会话列表失败: ${response.status}`);
            }
            const conversations = await response.json();

            // --- 【【核心修正】】 ---
            // 2. 在渲染列表之前，用获取到的数据填充前端用户缓存
            conversations.forEach(c => {
                if (c.type === 'PRIVATE') {
                    // 将每个私聊用户的信息存入 userCache
                    userCache[c.conversationId] = {
                        id: c.conversationId,
                        username: c.name,
                        avatarUrl: c.avatarUrl
                        // 这里我们只需要这些基本信息就足够了
                    };
                }
            });
            // --- 【【核心修正结束】】 ---

            // 3. 使用填充了缓存后的数据，正常渲染列表和启动状态更新
            renderConversationList(conversations);
            startStatusUpdates();

        } catch (e) {
            console.error('获取会话列表失败:', e);
        }
    }

    // 【【请用这个完整的函数替换你现有的 selectConversation 函数】】
    async function selectConversation(element) {
        lastMessageTimestamp = null; // 重置上一条消息的时间戳，用于显示时间分割线

        currentChat = {
            id: element.getAttribute('data-chat-id'),
            type: element.getAttribute('data-chat-type'),
            name: element.getAttribute('data-chat-name')
        };

        // UI更新：高亮选中项，显示聊天区域
        document.querySelectorAll('.conversation-item.active').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('chat-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = currentChat.name;

        // 清除可能存在的未读徽章
        const badgeEl = element.querySelector('.unread-badge');
        if (badgeEl) {
            badgeEl.remove();
        }

        // --- 【【核心修改在这里】】 ---
        // 1. 取消所有旧的订阅 (特别是上一个群聊的订阅)
        Object.values(activeSubscriptions).forEach(sub => sub.unsubscribe());
        for (const key in activeSubscriptions) {
            delete activeSubscriptions[key];
        }

        // 2. 只在选中群聊时，才去订阅群聊的topic
        if (currentChat.type === 'GROUP') {
            activeSubscriptions['group'] = stompClient.subscribe(`/topic/group/${currentChat.id}`, msg => {
                const parsedMsg = JSON.parse(msg.body);
                showMessage(parsedMsg);
                // 群聊消息也需要更新列表
                updateConversationListRealtime(parsedMsg, true);
            });
        }

        // 3. 订阅打字状态 (这部分逻辑不变)
        activeSubscriptions['typing'] = stompClient.subscribe(`/topic/typing/${currentChat.id}`, typingInfo => {
            const { username, isTyping } = JSON.parse(typingInfo.body);
            const statusEl = document.getElementById('chat-status');
            if (username !== currentUser.username) {
                statusEl.innerText = isTyping ? `${username} 正在输入...` : '';
                clearTimeout(typingTimeout);
                if (isTyping) {
                    typingTimeout = setTimeout(() => { statusEl.innerText = ''; }, 3000);
                }
            }
        });
        // --- 【【核心修改结束】】 ---

        // 更新聊天窗口顶部头像
        const headerAvatarEl = document.getElementById('chat-header-avatar');
        const chatPartner = userCache[currentChat.id];
        if (currentChat.type === 'PRIVATE' && chatPartner && chatPartner.avatarUrl) {
            headerAvatarEl.innerHTML = `<img src="${chatPartner.avatarUrl}" class="avatar">`;
        } else {
            headerAvatarEl.innerHTML = `<span>${currentChat.name.charAt(0).toUpperCase()}</span>`;
        }
        document.getElementById('chat-status').innerText = '';

        // 加载历史消息
        const msgWindow = document.getElementById('messages-window');
        msgWindow.innerHTML = '';
        try {
            const historyUrl = currentChat.type === 'GROUP'
                ? `${GATEWAY_URL}/api/messages/group/${currentChat.id}/history`
                : `${GATEWAY_URL}/api/messages/history?user1Id=${currentUser.id}&user2Id=${currentChat.id}`;
            const res = await fetchWithAuth(historyUrl);
            const messages = await res.json();
            messages.forEach(showMessage);
        } catch (e) {
            console.error("加载历史消息失败:", e);
        }
    }

    function sendMessage() {
        let content = messageInput.value;
        if (!content.trim() || !currentChat.id || !stompClient) return;

        content = content.replace(/@(\w+)/g, (match, username) => {
            // 在userCache中查找这个username对应的用户
            const user = Object.values(userCache).find(u => u.username === username);
            if (user) {
                // 如果找到了，就替换为带data-user-id的链接
                return `<span class="mention" data-user-id="<span class="math-inline">\{user\.id\}"\>@</span>{username}</span>`;
            }
            return match; // 如果没找到，保持原样
        });

        const payload = {
            senderId: currentUser.id,
            content: content,
            messageType: currentChat.type
        };

        if (currentChat.type === 'GROUP') payload.groupId = currentChat.id;
        else payload.recipientId = currentChat.id;

        stompClient.send("/app/chat", {}, JSON.stringify(payload));
        document.getElementById('message-content').value = '';
    }
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!currentChat.id) {
            alert("请先选择一个聊天窗口，然后再发送文件。");
            event.target.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/files/upload`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('文件上传失败');
            const result = await res.json();
            const fileUrl = result.url;

            let content = '';
            const isImage = file.type.startsWith('image/');

            if (isImage) {
                // 【【核心修改】】
                // 如果是图片，生成一个带容器的HTML结构
                // 这个 message-image-container 就是我们的“智能相框”
                content = `
                <div class="message-image-container" onclick="window.open('${fileUrl}')">
                    <img src="${fileUrl}" alt="图片加载中..." />
                </div>
            `;
            } else {
                // 非图片文件保持不变
                content = `<a href="${fileUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--c-primary); text-decoration: underline;">文件: ${file.name}</a>`;
            }

            const payload = {
                senderId: currentUser.id,
                content: content,
                messageType: currentChat.type
            };

            if (currentChat.type === 'GROUP') {
                payload.groupId = currentChat.id;
            } else {
                payload.recipientId = currentChat.id;
            }

            stompClient.send("/app/chat", {}, JSON.stringify(payload));

        } catch (e) {
            alert('操作失败: ' + e.message);
            console.error(e);
        }

        event.target.value = '';
    }

    function renderConversationList(conversations) {
        const list = document.getElementById('conversation-list');
        list.innerHTML = ''; // 清空旧列表

        if (!conversations || conversations.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: var(--c-text-light); padding: 50px;">暂无会话，找个朋友聊聊吧</p>';
            return;
        }

        // 新增一个内置的辅助函数，专门用于格式化最后一条消息
        const formatLastMessage = (content) => {
            if (!content) return '';
            const trimmedContent = content.trim();

            // 1. 优先判断是否为图片
            if (trimmedContent.includes('<img') || trimmedContent.includes('message-image-container')) {
                return '[图片]';
            }
            // 2. 判断是否为文件
            if (trimmedContent.includes('<a href')) {
                return '[文件]';
            }
            // 3. 判断是否为表情
            if (trimmedContent.includes('/emojis/')) {
                return '[表情]';
            }
            // 4. 如果是普通文本，移除所有HTML标签
            return trimmedContent.replace(/<[^>]*>?/gm, '');
        };

        conversations.forEach(c => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            if (c.type === 'PRIVATE') {
                item.id = `convo-user-${c.conversationId}`;
            }
            item.setAttribute('data-chat-id', c.conversationId);
            item.setAttribute('data-chat-type', c.type);
            item.setAttribute('data-chat-name', c.name);

            let avatarHtml = `<div class="avatar">${(c.name || '?').charAt(0).toUpperCase()}</div>`;
            if (c.avatarUrl) {
                avatarHtml = `<img class="avatar" src="${c.avatarUrl}" alt="${(c.name || '?').charAt(0)}">`;
            }

            let lastMessageTime = '';
            if (c.lastMessageTimestamp) {
                lastMessageTime = new Date(c.lastMessageTimestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // 【【【核心修改在这里】】】
            // 从服务器获取原始的最后一条消息内容
            const rawLastMessage = c.lastMessageContent || (c.type === 'GROUP' ? '群聊' : '私聊');
            // 调用我们刚刚定义的辅助函数，强制进行转换
            const formattedLastMessage = formatLastMessage(rawLastMessage);
            // 【【【核心修改在这里】】】

            const unreadCount = c.unreadCount || 0;

            item.innerHTML = `
        <div class="avatar-container">
            ${avatarHtml}
            ${c.type === 'PRIVATE' ? '<div class="status-dot offline"></div>' : ''}
        </div>
        <div class="conversation-details">
            <span class="conversation-name">${c.name}</span>
            <div class="last-message-content">${formattedLastMessage}</div>
        </div>
        <div class="conversation-meta">
            <span>${lastMessageTime}</span>
            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
        </div>
    `;

            const avatarContainer = item.querySelector('.avatar-container');
            if (avatarContainer) {
                avatarContainer.onclick = (event) => {
                    event.stopPropagation();
                    showUserProfile(c.conversationId);
                };
            }
            item.onclick = () => selectConversation(item);

            list.appendChild(item);
        });
    }

    function showMessage(message) {
        const msgWindow = document.getElementById('messages-window');
        const row = document.createElement('div');
        row.id = `message-${message.id}`;
        row.setAttribute('data-status', message.status || 'SENT');
        row.className = `message-row ${message.senderId === currentUser.id ? 'mine' : 'other'}`;

        // --- 优化时间显示逻辑 START ---
        let time = '';
        const currentTimestamp = new Date(message.timestamp);
        // 检查是否需要显示时间戳
        if (lastMessageTimestamp === null || (currentTimestamp - lastMessageTimestamp) > 5 * 60 * 1000) { // 超过5分钟
            time = currentTimestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        lastMessageTimestamp = currentTimestamp; // 更新上一条消息的时间
        // --- 优化时间显示逻辑 END ---


        // --- 已读回执逻辑 START ---
        let statusIcon = '';
        if (message.senderId === currentUser.id) {
            const iconId = `status-icon-${message.id}`;
            // 根据消息状态决定初始图标
            if (message.status === 'READ') {
                statusIcon = `<span id="${iconId}" class="message-status-icon read" style="color: #4ade80;">✓✓</span>`; // 已读：绿色双勾
            } else {
                statusIcon = `<span id="${iconId}" class="message-status-icon sent" style="color: var(--c-text-light);">✓</span>`; // 已发送：灰色单勾
            }
        }
        // --- 已读回执逻辑 END ---


        row.innerHTML = `
<div class="message-bubble">
    <div class="message-content">${message.content}</div>
    <div class="message-timestamp">
        <span>${time}</span>
        ${statusIcon}
    </div>
</div>`;

        msgWindow.appendChild(row);

        // 平滑滚动逻辑
        msgWindow.scrollTo({ top: msgWindow.scrollHeight, behavior: 'smooth' });
    }

    function startStatusUpdates() {
        if (statusUpdateInterval) clearInterval(statusUpdateInterval);
        updateAllStatuses();
        statusUpdateInterval = setInterval(updateAllStatuses, 10000);
    }

    async function updateAllStatuses() {
        const privateConvoItems = document.querySelectorAll('.conversation-item[data-chat-type="PRIVATE"]');
        if (privateConvoItems.length === 0) return;
        const userIds = Array.from(privateConvoItems).map(item => item.getAttribute('data-chat-id'));
        try {
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/presence/status/batch?userIds=${userIds.join(',')}`);
            const statuses = await res.json();
            for (const userId in statuses) {
                const convoItem = document.getElementById(`convo-user-${userId}`);
                if (convoItem) {
                    const dot = convoItem.querySelector('.status-dot');
                    if(dot) {
                        dot.className = `status-dot ${statuses[userId].toLowerCase()}`;
                    }
                }
            }
        } catch (e) { console.error("批量更新状态失败:", e); }
    }

    function openNavMenu() {
        const userAvatar = userCache[currentUser.id]?.avatarUrl;
        const navAvatar = document.getElementById('nav-avatar');
        if (userAvatar) {
            navAvatar.innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
            navAvatar.innerHTML = currentUser.username.charAt(0).toUpperCase();
        }
        document.getElementById('nav-menu').classList.add('open');
        document.getElementById('nav-menu-overlay').style.display = 'flex';
        document.getElementById('nav-username').innerText = currentUser.username;
    }

    function closeNavMenu() {
        document.getElementById('nav-menu').classList.remove('open');
        document.getElementById('nav-menu-overlay').style.display = 'none';
    }

    function handleTyping() {
        if (!stompClient || !currentChat.id) return;
        stompClient.send(`/app/typing/${currentChat.id}`, {}, currentUser.username);
    }

    function showSearchResults() {
        const query = document.getElementById('user-search-bar').value.trim();
        const resultsContainer = document.getElementById('search-results');
        if (query.length > 0 && resultsContainer.children.length > 0) {
            resultsContainer.style.display = 'block';
        }
    }

    function hideSearchResults() {
        setTimeout(() => {
            document.getElementById('search-results').style.display = 'none';
        }, 200);
    }

    function handleUserSearch(event) {
        console.log('【搜索探针 A】handleUserSearch 函数被触发。');
        clearTimeout(searchDebounceTimeout);
        const query = event.target.value.trim();
        const resultsContainer = document.getElementById('search-results');
        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }
        console.log('【搜索探针 B】准备搜索, 关键词:', query);
        searchDebounceTimeout = setTimeout(async () => {
            try {
                const response = await fetchWithAuth(`${GATEWAY_URL}/api/users/search?query=${query}`);
                const users = await response.json();
                console.log('【搜索探针 C】已获取用户数据，准备渲染:', users);
                renderSearchResults(users);
            } catch (error) { console.error("搜索用户失败:", error); }
        }, 500);
    }

    function renderSearchResults(users) {
        console.log('【搜索探针 D】renderSearchResults 被调用，用户数:', users.length);
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        if (users.length === 0) {
            resultsContainer.style.display = 'none';
            return;
        }

        users.forEach(user => {
            if (user.id == currentUser.id) return;
            const item = document.createElement('div');
            item.className = 'search-result-item';

            if (currentChat && currentChat.type === 'GROUP' && isCurrentUserGroupOwner) {
                item.onclick = () => addUserToGroup(user);
            } else {
                item.onclick = () => startPrivateChat(user);
            }

            let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
            if (user.avatarUrl) {
                avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
            }
            item.innerHTML = `${avatarHtml}<div style="margin-left: 10px;">${user.username}</div>`;
            resultsContainer.appendChild(item);
        });
        resultsContainer.style.display = 'block';
    }
    async function addUserToGroup(user) {
        if (!currentChat || currentChat.type !== 'GROUP' || !user) return;

        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members`, {
                method: 'POST',
                // 【【关键修正】】明确地添加 Content-Type 头
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId: user.id })
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(errorBody || '添加成员失败');
            }

            alert(`成功将 "${user.username}" 添加到群组!`);
            document.getElementById('user-search-bar').value = '';
            document.getElementById('search-results').style.display = 'none';

        } catch (error) {
            alert(`添加失败: ${error.message}`);
            console.error('添加群成员时出错:', error);
        }
    }
    function startPrivateChat(user) {
        hideSearchResults();
        document.getElementById('user-search-bar').value = '';
        let convoExists = false;
        document.querySelectorAll('.conversation-item').forEach(item => {
            if (item.getAttribute('data-chat-id') == user.id && item.getAttribute('data-chat-type') === 'PRIVATE') {
                convoExists = true;
                item.click();
            }
        });
        if (!convoExists) {
            const list = document.getElementById('conversation-list');
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.id = `convo-user-${user.id}`;
            item.setAttribute('data-chat-id', user.id);
            item.setAttribute('data-chat-type', 'PRIVATE');
            item.setAttribute('data-chat-name', user.username);
            item.onclick = () => selectConversation(item);
            let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
            if(user.avatarUrl) {
                avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
            }
            item.innerHTML = `<div class="avatar-container">${avatarHtml}<div class="status-dot offline"></div></div><div class="conversation-details"><span class="conversation-name">${user.username}</span><div class="last-message-content">私聊</div></div>`;
            list.prepend(item);
            item.click();
        }
    }

    function openCreateGroupModal() {
        closeNavMenu();
        document.getElementById('create-group-modal').style.display = 'flex';
    }

    function closeCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'none';
        document.getElementById('group-name').value = '';
        document.getElementById('group-description').value = '';
    }

    async function handleCreateGroup() {
        const name = document.getElementById('group-name').value.trim();
        const description = document.getElementById('group-description').value.trim();
        if (!name) { alert('请输入群组名称！'); return; }
        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/create`, {
                method: 'POST',
                body: JSON.stringify({ name, description })
            });
            if (!response.ok) throw new Error(await response.text() || '创建群组失败');
            const newGroup = await response.json();
            alert(`群组 "${newGroup.name}" 创建成功!`);
            closeCreateGroupModal();
            loadAndRenderConversations();
        } catch (error) {
            alert(error.message);
            console.error('创建群组出错:', error);
        }
    }

    function openProfileModal() {
        closeNavMenu();
        const currentUserProfile = userCache[currentUser.id] || currentUser;
        const userAvatar = currentUserProfile.avatarUrl;
        const userBio = currentUserProfile.bio;

        // 【关键】重置状态，清除上一次可能上传的头像URL
        const profileModal = document.getElementById('profile-modal');
        profileModal.removeAttribute('data-new-avatar-url');

        const avatarPreview = document.getElementById('profile-avatar-preview');
        if (userAvatar) {
            avatarPreview.style.display = 'block';
            avatarPreview.src = userAvatar;
        } else {
            avatarPreview.style.display = 'none';
        }
        document.getElementById('profile-username').value = currentUserProfile.username || '';
        document.getElementById('profile-bio').value = currentUserProfile.bio || '';
        profileModal.style.display = 'flex';
    }

    function closeProfileModal() {
        document.getElementById('profile-modal').style.display = 'none';
    }

    async function handleUpdateProfile() {
        const bio = document.getElementById('profile-bio').value;
        const username = document.getElementById('profile-username').value.trim();
        const newAvatarUrl = document.getElementById('profile-modal').getAttribute('data-new-avatar-url');

        // 创建一个 payload，只包含有变化的数据
        const payload = {};
        let hasUpdate = false;

        if (username && username !== (userCache[currentUser.id]?.username || '')) {
            payload.username = username;
            hasUpdate = true;
        }
        if (bio !== (userCache[currentUser.id]?.bio || '')) {
            payload.bio = bio;
            hasUpdate = true;
        }
        if (newAvatarUrl) {
            payload.avatarUrl = newAvatarUrl;
            hasUpdate = true;
        }

        // 如果没有任何更新，则直接关闭弹窗
        if (!hasUpdate) {
            closeProfileModal();
            return;
        }

        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/users/profile`, {
                method: 'PUT',
                body: JSON.stringify(payload) // 发送包含新头像URL和/或简介的请求
            });
            if (!response.ok) throw new Error('更新个人资料失败');

            // 后端在成功后会通过 RabbitMQ 和 WebSocket 广播事件 (user.profile.updated)
            // 前端的 handleUserUpdate 函数会自动监听到并刷新UI，所以这里不需要手动更新

            alert('个人资料已更新！');
            closeProfileModal();

        } catch(e) {
            alert(e.message);
            console.error("更新个人资料时出错: ", e);
        }
    }

    function handleUserUpdate(updatedUser) {
        if (!updatedUser || !updatedUser.id) return;

        console.log("【事件】接收到用户资料更新:", updatedUser);

        userCache[updatedUser.id] = updatedUser;

        if (currentUser && updatedUser.id === currentUser.id) {
            const navAvatar = document.getElementById('nav-avatar');
            const navUsername = document.getElementById('nav-username');
            if (updatedUser.avatarUrl) {
                navAvatar.innerHTML = `<img src="${updatedUser.avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                navAvatar.innerHTML = updatedUser.username.charAt(0).toUpperCase();
            }
            navUsername.innerText = updatedUser.username;
        }

        const conversationItem = document.querySelector(`.conversation-item[data-chat-id='${updatedUser.id}'][data-chat-type='PRIVATE']`);
        if (conversationItem) {
            // --- 【【核心修正从这里开始】】 ---
            const avatarContainer = conversationItem.querySelector('.avatar-container');
            const nameElement = conversationItem.querySelector('.conversation-name');

            if (avatarContainer && updatedUser.avatarUrl) {
                // 不再使用 outerHTML，而是修改容器内部的内容
                avatarContainer.innerHTML = `
                <img class="avatar" src="${updatedUser.avatarUrl}" alt="${updatedUser.username.charAt(0)}">
                <div class="status-dot offline"></div>
            `;
                // 重新绑定可能丢失的事件
                avatarContainer.onclick = (event) => {
                    event.stopPropagation();
                    showUserProfile(updatedUser.id);
                };
            }

            if (nameElement) {
                nameElement.textContent = updatedUser.username;
            }
            // --- 【【核心修正到这里结束】】 ---
        }

        if (currentChat.id == updatedUser.id && currentChat.type === 'PRIVATE') {
            const headerAvatar = document.getElementById('chat-header-avatar');
            const headerTitle = document.getElementById('chat-title');

            if (headerAvatar) {
                if (updatedUser.avatarUrl) {
                    headerAvatar.innerHTML = `<img src="${updatedUser.avatarUrl}" class="avatar">`;
                } else {
                    headerAvatar.innerHTML = `<span>${updatedUser.username.charAt(0).toUpperCase()}</span>`;
                }
            }
            if(headerTitle) {
                headerTitle.innerText = updatedUser.username;
            }
        }
        loadAndRenderConversations();
    }

    function closeViewMembersModal() {
        document.getElementById('view-members-modal').style.display = 'none';
        // 清空上一次的列表，以免下次打开时看到旧数据
        document.getElementById('members-list-container').innerHTML = '';
    }

    /**
     * 【【新增函数】】
     * 获取并显示当前群组的成员列表
     */
    async function showGroupMembers() {
        if (!currentChat || currentChat.type !== 'GROUP') return;

        try {
            // 1. 调用 group-service 获取成员ID列表
            const membersRes = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members`);
            if (!membersRes.ok) throw new Error('获取群成员失败');
            const memberIds = await membersRes.json();

            // 【新增】获取群组的详细信息，我们需要知道谁是群主
            const groupInfoRes = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}`);
            if (!groupInfoRes.ok) throw new Error('获取群组信息失败');
            const groupInfo = await groupInfoRes.json();
            const ownerId = groupInfo.ownerId;

            if (memberIds.length === 0) {
                document.getElementById('members-list-container').innerHTML = '<p>这个群还没有成员。</p>';
            } else {
                // 2. 调用 user-service 批量获取成员的详细信息
                const usersRes = await fetchWithAuth(`${GATEWAY_URL}/api/users/batch?ids=${memberIds.join(',')}`);
                if (!usersRes.ok) throw new Error('获取成员详细信息失败');
                const memberUsers = await usersRes.json();

                // 3. 构建HTML并显示
                const listContainer = document.getElementById('members-list-container');
                listContainer.innerHTML = ''; // 先清空
                memberUsers.forEach(user => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'search-result-item';

                    let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
                    if (user.avatarUrl) {
                        avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
                    }

                    // 【核心修改】判断是否要显示“移除”按钮
                    let removeBtnHtml = '';
                    // 如果当前登录用户是群主，并且列表中的这个成员不是群主自己
                    if (currentUser.id === ownerId && user.id !== ownerId) {
                        removeBtnHtml = `<button class="btn-cancel" style="margin-left: auto;" onclick="removeGroupMember(${user.id}, '${user.username}')">移除</button>`;
                    }

                    memberItem.innerHTML = `${avatarHtml}<div style="margin-left: 10px;">${user.username}</div>${removeBtnHtml}`;
                    memberItem.querySelector('.avatar').onclick = (event) => {
                        event.stopPropagation();
                        showUserProfile(user.id);
                    };
                    listContainer.appendChild(memberItem);
                });
            }

            document.getElementById('view-members-title').innerText = `"${currentChat.name}" 的成员`;
            document.getElementById('view-members-modal').style.display = 'flex';

        } catch (error) {
            alert(error.message);
            console.error('查看群成员时出错:', error);
        }
    }
    async function removeGroupMember(userIdToRemove, username) {
        if (!confirm(`您确定要将 "${username}" 移出群聊吗？`)) {
            return;
        }
        if (!currentChat || currentChat.type !== 'GROUP') return;

        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members/${userIdToRemove}`, {
                method: 'DELETE'
                // DELETE请求通常不需要body和Content-Type，所以这里保持简洁即可
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(errorBody || '移除成员失败');
            }

            alert(`已成功将 "${username}" 移出群组。`);
            showGroupMembers(); // 刷新成员列表

        } catch (error) {
            alert(`移除失败: ${error.message}`);
            console.error('移除群成员时出错:', error);
        }
    }

    async function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            // 1. 调用 file-service 上传文件
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/files/upload`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('头像上传失败');
            const result = await res.json();
            const newAvatarUrl = result.url; // 获取到新的头像 URL

            // 2. 更新个人资料弹窗中的头像预览
            const avatarPreview = document.getElementById('profile-avatar-preview');
            avatarPreview.src = newAvatarUrl;
            avatarPreview.style.display = 'block';

            // 3. 【关键】将新的 URL 存储在按钮的一个自定义属性中，方便“保存”时获取
            document.getElementById('profile-modal').setAttribute('data-new-avatar-url', newAvatarUrl);

        } catch (e) {
            alert('操作失败: ' + e.message);
            console.error(e);
        } finally {
            // 清空文件输入框的值，以便用户可以再次选择同一个文件
            event.target.value = '';
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        // 确保在DOM加载完毕后获取元素
        const emojiWrapper = document.getElementById('emoji-wrapper');
        const emojiPanel = document.getElementById('emoji-panel');

        // 检查元素是否存在，防止报错
        if (!emojiWrapper || !emojiPanel) {
            console.error('Emoji wrapper or panel not found!');
            return;
        }

        let emojiLoaded = false;
        let hidePanelTimeout;

        async function loadEmojis() {
            if (emojiLoaded) return;
            emojiLoaded = true;
            emojiPanel.innerHTML = '正在加载...';
            try {
                const response = await fetch(`${GATEWAY_URL}/api/emojis/list`);
                if (!response.ok) throw new Error('获取表情列表失败');
                const emojiFileList = await response.json();
                emojiPanel.innerHTML = '';
                emojiFileList.forEach(fileName => {
                    const emojiImg = document.createElement('img');
                    emojiImg.src = `/emojis/${fileName}`;
                    emojiImg.style.width = '28px';
                    emojiImg.style.height = '28px';
                    emojiImg.style.cursor = 'pointer';
                    emojiImg.title = fileName.split('.')[0];
                    emojiImg.onclick = () => sendEmojiAsImage(fileName);
                    emojiPanel.appendChild(emojiImg);
                });
            } catch (error) {
                console.error("加载表情列表失败:", error);
                emojiPanel.innerHTML = '加载失败';
            }
        }

        emojiWrapper.addEventListener('mouseenter', () => {
            clearTimeout(hidePanelTimeout);
            loadEmojis();
            emojiPanel.style.display = 'grid';
        });

        emojiWrapper.addEventListener('mouseleave', () => {
            hidePanelTimeout = setTimeout(() => {
                emojiPanel.style.display = 'none';
            }, 300);
        });
    });
    // ---- 最终版悬停逻辑 END ----

    // 发送表情的函数 (确保这个函数存在)
    function sendEmojiAsImage(fileName) {
        if (!currentChat.id || !stompClient) return;
        const content = `<img src="/emojis/${fileName}" style="width: 28px; height: 28px; vertical-align: middle;">`;
        const payload = {
            senderId: currentUser.id,
            content: content,
            messageType: currentChat.type,
            groupId: currentChat.type === 'GROUP' ? currentChat.id : null,
            recipientId: currentChat.type === 'PRIVATE' ? currentChat.id : null,
        };
        stompClient.send("/app/chat", {}, JSON.stringify(payload));
        document.getElementById('emoji-panel').style.display = 'none';
    }

    const messageInput = document.getElementById('message-content');
    const mentionsPopup = document.getElementById('mentions-popup');

    messageInput.addEventListener('input', handleMentionInput);

    async function handleMentionInput(event) {
        const text = event.target.value;
        const atIndex = text.lastIndexOf('@');

        // 只有在群聊中，且光标在@符号后才触发
        if (currentChat.type === 'GROUP' && atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            try {
                console.log('正在为群组ID获取成员, currentChat.id 的值是:', currentChat.id);
                console.log('完整的 currentChat 对象是:', currentChat);
                // 【核心修正】确保这里正确地构造了请求URL
                const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members/details`);

                if (!response.ok) { // 检查请求是否成功
                    throw new Error(`服务器错误: ${response.status}`);
                }

                const members = await response.json(); // 现在 members 一定是一个数组

                // 根据输入过滤成员
                const filteredMembers = members.filter(m =>
                    m.username.toLowerCase().includes(query.toLowerCase())
                );

                renderMentionsPopup(filteredMembers, atIndex);

            } catch (error) {
                console.error('获取群成员失败:', error);
                mentionsPopup.style.display = 'none';
            }
        } else {
            mentionsPopup.style.display = 'none';
        }
    }

    function renderMentionsPopup(members, atIndex) {
        if (members.length === 0) {
            mentionsPopup.style.display = 'none';
            return;
        }
        mentionsPopup.innerHTML = '';
        members.forEach(member => {
            const item = document.createElement('div');
            item.className = 'mention-item';
            item.onclick = () => selectMention(member, atIndex);
            // 假设userCache中有头像信息
            const user = userCache[member.id] || {};
            let avatarHtml = `<div class="avatar">${member.username.charAt(0).toUpperCase()}</div>`;
            if(user.avatarUrl) {
                avatarHtml = `<img src="${user.avatarUrl}" class="avatar">`;
            }
            item.innerHTML = `${avatarHtml}<span>${member.username}</span>`;
            mentionsPopup.appendChild(item);
        });
        mentionsPopup.style.display = 'block';
    }
    function selectMention(member, atIndex) {
        const currentText = messageInput.value;
        // 替换@query为@username
        const newText = currentText.substring(0, atIndex) + `@${member.username} `;
        messageInput.value = newText;
        messageInput.focus();
        mentionsPopup.style.display = 'none';
    }
    async function showUserProfile(userId) {
        if (!userId) return;
        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/users/${userId}`);
            if (!response.ok) throw new Error('无法获取该用户信息');
            const user = await response.json();
            // 填充数据
            document.getElementById('profile-page-avatar').src = user.avatarUrl || `https://ui-avatars.com/api/?name=${user.username}&background=random`;
            document.getElementById('profile-page-username').innerText = user.username;
            document.getElementById('profile-page-custom-id').innerText = `@${user.customId}`;
            document.getElementById('profile-page-bio').innerText = user.bio || '这位用户很神秘，什么也没留下...';
            viewingProfileUserId = user.id; // 记录当前查看的用户ID
            // 显示弹窗
            const modal = document.getElementById('user-profile-modal');
            modal.style.display = 'flex';
            // 使用一个微小的延迟来触发CSS动效
            setTimeout(() => modal.classList.add('visible'), 10);
        } catch (error) {
            alert(error.message);
        }
    }
    // 关闭用户主页
    function closeUserProfileModal() {
        const modal = document.getElementById('user-profile-modal');
        modal.classList.remove('visible');
        // 等待动效结束后再隐藏
        setTimeout(() => {
            modal.style.display = 'none';
            viewingProfileUserId = null; // 清理ID
        }, 300);
    }
    // 从主页上发起聊天
    function startChatFromProfile() {
        if (viewingProfileUserId) {
            const userToChat = userCache[viewingProfileUserId];
            if (userToChat) {
                startPrivateChat(userToChat);
                closeUserProfileModal(); // 发起聊天后关闭主页
            }
        }
    }
</script>
</body>
</html>
