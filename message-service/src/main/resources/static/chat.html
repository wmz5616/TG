<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Telegram</title>
    <style>
        /* 变量定义 */
        :root {
            --c-bg: #18222d;
            --c-bg-light: #212c37;
            --c-bg-lighter: #2a3542;
            --c-text: #ffffff;
            --c-text-light: #a3a3a3;
            --c-primary: #3390ec;
            --c-sent-bubble: #4f94f0;
            --c-received-bubble: var(--c-bg-lighter);
            --c-online: #4ade80;
            --c-offline: #71717a;
        }

        /* 基础与重置 */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            overflow: hidden;
            height: 100vh;
        }

        /* 主体布局 */
        .app-container { display: none; height: 100vh; }
        .sidebar { width: 320px; min-width: 320px; background-color: var(--c-bg-light); border-right: 1px solid var(--c-bg-lighter); display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--c-bg); }

        /* 侧边栏头部 (Telegram风格) */
        .sidebar-header { padding: 10px 15px; }
        .search-container { position: relative; display: flex; align-items: center; }
        .menu-button { position: absolute; left: 0; top: 0; height: 100%; background: none; border: none; cursor: pointer; padding: 0 12px; display: flex; align-items: center; justify-content: center; z-index: 2; border-radius: 50%; }
        .menu-button:hover { background-color: rgba(255,255,255,0.1); }
        .search-bar { background-color: var(--c-bg); border: none; border-radius: 20px; padding: 10px 15px 10px 45px; width: 100%; color: var(--c-text); font-size: 14px; }
        .search-bar::placeholder { color: var(--c-text-light); }
        .search-bar:focus { outline: 1px solid var(--c-primary); }

        /* 会话列表与搜索结果 */
        .conversation-list-container { position: relative; flex-grow: 1; overflow: hidden; }
        .conversation-list { height: 100%; overflow-y: auto; }
        .search-results { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--c-bg-light); z-index: 100; overflow-y: auto; display: none; }
        .search-result-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; }
        .search-result-item:hover { background-color: var(--c-bg-lighter); }
        .conversation-item { position: relative; display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--c-bg); transition: background-color 0.2s; }
        .conversation-item:hover { background-color: var(--c-bg-lighter); }
        .conversation-item.active { background-color: var(--c-primary); }
        .avatar-container { position: relative; margin-right: 12px; flex-shrink: 0; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--c-primary); display: flex; align-items: center; justify-content: center; font-weight: 600; object-fit: cover; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--c-bg-light); background-color: var(--c-offline); }
        .status-dot.online { background-color: var(--c-online); }
        .conversation-details { flex-grow: 1; overflow: hidden; }
        .conversation-name { font-weight: 600; font-size: 15px; }
        .last-message-content { font-size: 14px; color: var(--c-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }

        /* 聊天区 */
        #chat-area { display: none; flex-grow: 1; flex-direction: column; height: 100%; }
        .chat-header { display: flex; align-items: center; padding: 10px 20px; background-color: var(--c-bg-light); border-bottom: 1px solid var(--c-bg-lighter); flex-shrink: 0; }
        #chat-header-avatar { width: 40px; height: 40px; margin-right: 15px; }
        #chat-status { font-size: 13px; color: var(--c-primary-light); height: 18px; transition: color 0.3s ease; }
        .messages-window { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message-row { display: flex; margin-bottom: 15px; }
        .message-row.mine { justify-content: flex-end; }
        .message-bubble { max-width: 60%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-break: break-word; }
        .message-row.mine .message-bubble { background-color: var(--c-sent-bubble); }
        .message-row.other .message-bubble { background-color: var(--c-received-bubble); }
        .message-content img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .message-input-area { display: flex; align-items: center; padding: 10px 20px; background-color: var(--c-bg-light); flex-shrink: 0; }
        #message-content { flex-grow: 1; background-color: var(--c-bg); border: 1px solid var(--c-bg-lighter); border-radius: 20px; padding: 12px 20px; color: var(--c-text); font-size: 15px; }
        #message-content:focus { outline: none; border-color: var(--c-primary); }
        .input-button { background: none; border: none; cursor: pointer; padding: 10px; }
        .input-button svg { width: 24px; height: 24px; color: var(--c-text-light); }
        .send-button { background-color: var(--c-primary); border: none; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 10px;}

        /* 弹窗与遮罩层 */
        .login-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .login-box, .modal-box { background-color: var(--c-bg-light); padding: 40px; border-radius: 12px; text-align: center; }
        .login-box input { display: block; margin: 0 auto 15px auto; background-color: var(--c-bg); border: 1px solid var(--c-bg-lighter); border-radius: 8px; padding: 12px; width: 220px; color: var(--c-text); }
        .login-box button { background-color: var(--c-primary); border: none; border-radius: 8px; padding: 12px 20px; width: 220px; color: white; font-weight: 600; cursor: pointer; }

        #create-group-modal, #profile-modal { display: none; }
        .modal-box { width: 400px; text-align: left; }
        .modal-box h3 { margin-bottom: 20px; }
        .modal-box input, .modal-box textarea { width: 100%; text-align: left; background-color: var(--c-bg); border: 1px solid var(--c-bg-lighter); border-radius: 8px; padding: 12px; color: var(--c-text); margin-bottom: 15px; }
        #profile-bio { height: 80px; resize: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-actions button { border: none; border-radius: 8px; padding: 10px 20px; font-weight: 600; cursor: pointer; width: auto; }
        .modal-actions .btn-cancel { background-color: var(--c-bg-lighter); color: var(--c-text); }
        .modal-actions .btn-create { background-color: var(--c-primary); color: white; }

        /* 欢迎页面 */
        #welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; text-align: center; color: var(--c-text-light); }
        #welcome-screen svg { width: 80px; height: 80px; color: var(--c-bg-lighter); margin-bottom: 20px; }

        /* 滑动菜单 */
        .nav-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: var(--c-bg-light); z-index: 1002; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .nav-menu.open { transform: translateX(0); }
        .nav-menu-header { padding: 20px; background-color: var(--c-primary); cursor: pointer; }
        .nav-menu-header:hover { background-color: var(--c-primary-light); }
        .nav-menu-header .avatar { width: 60px; height: 60px; margin-bottom: 10px; background-color: white; color: var(--c-primary); }
        .nav-menu-header h4 { font-size: 18px; }
        .nav-menu-list { list-style: none; padding: 10px 0; }
        .nav-menu-list li { display: flex; align-items: center; padding: 15px 20px; cursor: pointer; }
        .nav-menu-list li:hover { background-color: var(--c-bg-lighter); }
        .nav-menu-list li svg { margin-right: 20px; color: var(--c-text-light); }
        #profile-avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; display: block; margin: 0 auto 20px; border: 3px solid var(--c-bg-lighter); }
        #avatar-upload-btn { width: 100%; padding: 12px; border-radius: 8px; border: none; background-color: var(--c-bg-lighter); color: var(--c-text); cursor: pointer; margin-bottom: 15px; }

        /* “无感”滚动条 */
        .messages-window::-webkit-scrollbar, .conversation-list::-webkit-scrollbar, .search-results::-webkit-scrollbar { width: 6px; }
        .messages-window::-webkit-scrollbar-track, .conversation-list::-webkit-scrollbar-track, .search-results::-webkit-scrollbar-track { background: transparent; }
        .messages-window::-webkit-scrollbar-thumb, .conversation-list::-webkit-scrollbar-thumb, .search-results::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 3px; }
        .messages-window:hover::-webkit-scrollbar-thumb, .conversation-list:hover::-webkit-scrollbar-thumb, .search-results:hover::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.25); }

        .message-status-icon { margin-left: 5px; font-weight: bold; color: var(--c-text-light); /* 默认灰色 */}
        .message-status-icon.read { color: var(--c-primary); /* 已读后变为蓝色 */}
        .message-image-container { display: block; max-width: 300px; max-height: 400px; border-radius: 12px; overflow: hidden; cursor: pointer; background-color: var(--c-bg); aspect-ratio: 4 / 3; }
        .message-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .message-bubble:has(.message-image-container) { padding: 0; background-color: transparent; }
    </style>
</head>
<body>
<div id="login-overlay" class="login-overlay">
    <div class="login-box">
        <h3>登录 Mini-Telegram</h3>
        <p id="login-error" style="color: #f87171; height: 20px;"></p>
        <input type="text" id="login-username" placeholder="用户名" >
        <input type="password" id="login-password" placeholder="密码" onkeydown="if(event.key === 'Enter') login()">
        <button onclick="login()">登 录</button>
    </div>
</div>

<div id="create-group-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>创建新群组</h3>
        <input type="text" id="group-name" placeholder="群组名称">
        <input type="text" id="group-description" placeholder="群组描述（可选）">
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCreateGroupModal()">取消</button>
            <button class="btn-create" onclick="handleCreateGroup()">创建</button>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-box">
        <h3>编辑个人资料</h3>
        <img id="profile-avatar-preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="avatar">
        <button id="avatar-upload-btn" onclick="triggerFileUpload()">更换头像</button>
        <label for="profile-bio">个人简介</label>
        <textarea id="profile-bio" placeholder="留下你的足迹..."></textarea>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeProfileModal()">取消</button>
            <button class="btn-create" onclick="handleUpdateProfile()">保存</button>
        </div>
    </div>
</div>

<div id="nav-menu-overlay" class="modal-overlay" style="display: none; z-index: 1000;" onclick="closeNavMenu()"></div>
<div id="nav-menu" class="nav-menu">
    <div class="nav-menu-header" onclick="openProfileModal()">
        <div id="nav-avatar" class="avatar"></div>
        <h4 id="nav-username"></h4>
    </div>
    <ul class="nav-menu-list">
        <li onclick="openCreateGroupModal()">
            <svg fill="currentColor" width="24" height="24" viewBox="0 0 256 256"><path d="M168,128a12,12,0,0,1-12,12H132v24a12,12,0,0,1-24,0V140H84a12,12,0,0,1,0-24h24V92a12,12,0,0,1,24,0v24h24A12,12,0,0,1,168,128Zm80-40.75a12,12,0,0,1-7.1,11.07l-34.7,17.34.1,0L178.9,133a12,12,0,0,1-9,22.5h-1.5l-33.5-20.09.2.3a12,12,0,0,1-21.2,0l-.2-.3-33.5,20.09h-1.5a12,12,0,0,1-9-22.5l-27.4-17.15.1,0-34.7-17.34A12,12,0,0,1,8,87.25V72a12,12,0,0,1,12-12H236a12,12,0,0,1,12,12Z"></path></svg>
            <span>创建群组</span>
        </li>
    </ul>
</div>

<div id="view-members-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <h3 id="view-members-title">群组成员</h3>
        <div id="members-list-container" style="max-height: 400px; overflow-y: auto;">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeViewMembersModal()">关闭</button>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="search-container">
                <button class="menu-button" onclick="openNavMenu()">
                    <svg fill="var(--c-text-light)" width="24" height="24" viewBox="0 0 256 256"><path d="M224,128a12,12,0,0,1-12,12H44a12,12,0,0,1,0-24H212A12,12,0,0,1,224,128ZM44,76H212a12,12,0,0,0,0-24H44a12,12,0,0,0,0,24Zm168,104H44a12,12,0,0,0,0,24H212a12,12,0,0,0,0-24Z"></path></svg>
                </button>
                <input type="text" id="user-search-bar" class="search-bar" placeholder="搜索用户或群组" oninput="handleUserSearch(event)" onfocus="showSearchResults()" onblur="hideSearchResults()">
            </div>
        </div>
        <div class="conversation-list-container">
            <div id="conversation-list" class="conversation-list"></div>
            <div id="search-results" class="search-results"></div>
        </div>
    </div>
    <div class="main-content">
        <div id="chat-area">
            <div class="chat-header">
                <div id="chat-header-avatar" class="avatar"></div>
                <div>
                    <h4 id="chat-title"></h4>
                    <small id="chat-status"></small>
                </div>
                <button id="add-member-btn" class="input-button" title="添加成员" style="margin-left: auto; display: none;">
                </button>
                <button id="view-members-btn" class="input-button" title="查看成员" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M176,144a12,12,0,0,1-12,12H92a12,12,0,0,1,0-24h72A12,12,0,0,1,176,144Zm-12-52a12,12,0,0,0-12-12H92a12,12,0,0,0,0,24h60A12,12,0,0,0,164,92Zm44,36A104,104,0,1,1,104,24,104.11,104.11,0,0,1,208,128ZM104,40a88,88,0,1,0,88,88A88.1,88.1,0,0,0,104,40Z"></path></svg>
                </button>
            </div>
            <div id="messages-window" class="messages-window"></div>
            <div class="message-input-area">
                <button class="input-button" onclick="triggerFileUpload()" title="上传文件">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M165.27,133.27a12,12,0,0,1-17,0L116,100.94V192a12,12,0,0,1-24,0V100.94L59.73,133.27a12,12,0,0,1-17-17l52-52a12,12,0,0,1,17,0l52,52A12,12,0,0,1,165.27,133.27ZM236,132a12,12,0,0,1-12,12H188a12,12,0,0,1,0-24h36V80H32v32H68a12,12,0,0,1,0,24H32a12,12,0,0,1-12-12V80A12,12,0,0,1,32,68H224a12,12,0,0,1,12,12Z"></path></svg>
                </button>
                <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(event)">
                <input type="text" id="message-content" placeholder="输入消息..." onkeydown="handleKeydown(event)" oninput="handleTyping()">
                <button class="send-button" onclick="sendMessage()" title="发送消息">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256"><path d="M240,12.28a15.82,15.82,0,0,0-15.68-4L12.37,88.45a16,16,0,0,0,2.5,29.74l63.26,24.81,21.28,56.28A16,16,0,0,0,116,211.72a15.86,15.86,0,0,0,12.55-6.08l80-212A16,16,0,0,0,240,12.28ZM117.7,196.28l-21.27-56.28L176,84Z"></path></svg>
                </button>
            </div>
        </div>
        <div id="welcome-screen">
            <svg width="80" height="80" fill="var(--c-bg-lighter)" viewBox="0 0 256 256"><path d="M128,24A104,104,0,0,0,36.18,176.88L24.83,210.93a16,16,0,0,0,20.24,20.24l34.05-11.35A104,104,0,1,0,128,24Zm0,192a88,88,0,0,1-45.15-13.16L38.3,221.7a8,8,0,0,1-10-10L46.84,167.15A88,88,0,1,1,128,216Z"></path></svg>
            <p style="color: var(--c-text-light); margin-top: 20px;">请从左侧选择一个会话开始聊天</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const GATEWAY_URL = 'http://localhost:8888';
    var stompClient = null;
    var currentUser = { id: null, username: null };
    var currentChat = { id: null, type: null, name: null };
    var userCache = {};
    var statusUpdateInterval = null;
    var activeSubscriptions = {};
    var typingTimeout = null;
    var searchDebounceTimeout = null;

    // --- 辅助函数 ---
    function handleKeydown(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
    function triggerFileUpload() { document.getElementById('file-input').click(); }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            alert("认证信息不存在或已过期，请重新登录。");
            window.location.reload();
            return Promise.reject("No token found");
        }
        const defaultHeaders = { 'Authorization': `Bearer ${token}` };
        if (!(options.body instanceof FormData)) {
            defaultHeaders['Content-Type'] = 'application/json';
        }
        const finalHeaders = { ...defaultHeaders, ...options.headers };
        const finalOptions = { ...options, headers: finalHeaders };
        return fetch(url, finalOptions);
    }

    // --- 核心认证与连接 ---
    async function login() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const errorEl = document.getElementById('login-error');
        if (!username || !password) {
            errorEl.innerText = '请输入用户名和密码！';
            return;
        }
        errorEl.innerText = '';
        try {
            const response = await fetch(`${GATEWAY_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (!response.ok) throw new Error('用户名或密码错误！');
            const data = await response.json();
            localStorage.setItem('jwt_token', data.jwt);
            currentUser = { id: data.userId, username: data.username };

            const profileResponse = await fetchWithAuth(`${GATEWAY_URL}/api/users/${currentUser.id}`);
            if (!profileResponse.ok) throw new Error('获取用户个人资料失败');
            const fullUserProfile = await profileResponse.json();

            userCache[currentUser.id] = fullUserProfile;

            connectWebSocket();
        } catch (error) {
            errorEl.innerText = error.message;
        }
    }

    function connectWebSocket() {
        const token = localStorage.getItem('jwt_token');
        const headers = { 'userId': currentUser.id };
        const socket = new SockJS(`${GATEWAY_URL}/ws?token=${token}`);
        stompClient = Stomp.over(socket);

        stompClient.connect(headers, frame => {
            document.getElementById('login-overlay').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';

            stompClient.subscribe('/topic/users/updated', message => {
                const updatedUser = JSON.parse(message.body);
                handleUserUpdate(updatedUser);
            });

            stompClient.subscribe('/user/queue/status', message => {
                console.log('【探针2】从服务器收到消息状态更新:', JSON.parse(message.body));
                const statusUpdate = JSON.parse(message.body);
                const iconEl = document.getElementById(`status-icon-${statusUpdate.messageId}`);

                if (iconEl && statusUpdate.status === 'READ') {
                    // 根据您的要求，变为两个绿色的对勾
                    iconEl.innerHTML = '✓✓';
                    iconEl.style.color = '#4ade80'; // 设置为绿色
                    iconEl.className = 'message-status-icon read'; // 添加 'read' 类
                }
            });

            loadAndRenderConversations();
        });
    }

    // --- 业务功能 ---
    async function loadAndRenderConversations() {
        try {
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/groups/user/${currentUser.id}`);
            const groups = await res.json();
            const privateRes = await fetchWithAuth(`${GATEWAY_URL}/api/messages/conversations/private/${currentUser.id}`);
            const partnerIds = await privateRes.json();
            let convos = [];
            groups.forEach(g => convos.push({ id: g.id, type: 'GROUP', name: g.name }));
            const userIdsToFetch = [...new Set(partnerIds)].filter(id => !userCache[id]);
            if (userIdsToFetch.length > 0) {
                const usersRes = await fetchWithAuth(`${GATEWAY_URL}/api/users/batch?ids=${userIdsToFetch.join(',')}`);
                const users = await usersRes.json();
                users.forEach(u => { userCache[u.id] = u; });
            }
            partnerIds.forEach(id => {
                if(userCache[id]) convos.push({ id, type: 'PRIVATE', name: userCache[id].username });
            });
            renderConversationList(convos);
            startStatusUpdates();
        } catch (e) { console.error('获取会话列表失败:', e); }
    }

    async function selectConversation(element) {
        currentChat = {
            id: element.getAttribute('data-chat-id'),
            type: element.getAttribute('data-chat-type'),
            name: element.getAttribute('data-chat-name')
        };

        document.querySelectorAll('.conversation-item.active').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('chat-area').style.display = 'flex';
        document.getElementById('chat-title').innerText = currentChat.name;
        const addMemberBtn = document.getElementById('add-member-btn');
        const viewMembersBtn = document.getElementById('view-members-btn');

        if (currentChat.type === 'GROUP') {
            addMemberBtn.style.display = 'block';
            viewMembersBtn.style.display = 'block';
            // 【【新增代码】】为按钮绑定点击事件
            viewMembersBtn.onclick = showGroupMembers;
        } else {
            addMemberBtn.style.display = 'none';
            viewMembersBtn.style.display = 'none';
        }

        const headerAvatarEl = document.getElementById('chat-header-avatar');
        const chatPartner = userCache[currentChat.id];
        if (currentChat.type === 'PRIVATE' && chatPartner && chatPartner.avatarUrl) {
            headerAvatarEl.innerHTML = `<img src="${chatPartner.avatarUrl}" class="avatar">`;
        } else {
            headerAvatarEl.innerHTML = `<span>${currentChat.name.charAt(0).toUpperCase()}</span>`;
        }
        document.getElementById('chat-status').innerText = '';

        const msgWindow = document.getElementById('messages-window');
        msgWindow.innerHTML = '';

        Object.values(activeSubscriptions).forEach(sub => sub.unsubscribe());
        activeSubscriptions = {};

        activeSubscriptions['private'] = stompClient.subscribe(`/user/${currentUser.id}/queue/messages`, msg => {
            const parsedMsg = JSON.parse(msg.body);
            if (currentChat.type === 'PRIVATE' && (parsedMsg.senderId == currentChat.id || parsedMsg.recipientId == currentChat.id)) {
                showMessage(parsedMsg);
            }
        });

        if (currentChat.type === 'GROUP') {
            activeSubscriptions['group'] = stompClient.subscribe(`/topic/group/${currentChat.id}`, msg => {
                // 直接调用showMessage，显示所有收到的群聊消息
                showMessage(JSON.parse(msg.body));
            });
        }

        activeSubscriptions['typing'] = stompClient.subscribe(`/topic/typing/${currentChat.id}`, typingInfo => {
            const { username, isTyping } = JSON.parse(typingInfo.body);
            const statusEl = document.getElementById('chat-status');
            if (username !== currentUser.username) {
                statusEl.innerText = isTyping ? `${username} 正在输入...` : '';
                clearTimeout(typingTimeout);
                if (isTyping) {
                    typingTimeout = setTimeout(() => { statusEl.innerText = ''; }, 3000);
                }
            }
        });

        try {
            const historyUrl = currentChat.type === 'GROUP'
                ? `${GATEWAY_URL}/api/messages/group/${currentChat.id}/history`
                : `${GATEWAY_URL}/api/messages/history?user1Id=${currentUser.id}&user2Id=${currentChat.id}`;
            const res = await fetchWithAuth(historyUrl);
            const messages = await res.json();
            messages.forEach(showMessage);
        } catch (e) {
            console.error("加载历史消息失败:", e);
        }

        // ... selectConversation 函数的主体代码 ...

        // 【【使用这个新的调试版本替换旧的 setTimeout 代码块】】
        setTimeout(() => {
            console.log('【调试】开始检测未读消息...');

            // 探针A: 先获取所有对方发来的消息，看看有多少条
            const allOtherMessages = document.querySelectorAll('.message-row.other');
            console.log(`【调试】总共找到 ${allOtherMessages.length} 条对方发来的消息。`);

            // 探针B: 遍历每一条消息，打印出它的ID和data-status属性
            allOtherMessages.forEach((msgEl, index) => {
                console.log(`【调试】消息 ${index + 1}: ID=${msgEl.id}, Status=${msgEl.getAttribute('data-status')}`);
            });

            // 我们要执行的筛选操作
            const unreadMessages = document.querySelectorAll('.message-row.other:not([data-status="READ"])');
            console.log(`【调试】其中，找到 ${unreadMessages.length} 条未读消息。`);

            if (unreadMessages.length > 0) {
                const messageIds = Array.from(unreadMessages).map(msgEl => msgEl.id.split('-')[1]);
                const payload = {
                    messageIds: messageIds,
                    readerId: currentUser.id
                };
                stompClient.send("/app/messages.read", {}, JSON.stringify(payload));
                console.log('【调试】已发送已读回执给服务器, 消息ID:', messageIds);
                unreadMessages.forEach(msgEl => msgEl.setAttribute('data-status', 'READ'));
            } else {
                console.log('【调试】没有需要发送的已读回执。');
            }
        }, 1000); // 将延迟增加到1秒，确保DOM渲染完毕
    } // 这是 selectConversation 函数的结束括号

    function sendMessage() {
        const content = document.getElementById('message-content').value;
        if (!content.trim() || !currentChat.id || !stompClient) return;

        const payload = {
            senderId: currentUser.id,
            content: content,
            messageType: currentChat.type
        };
        if (currentChat.type === 'GROUP') payload.groupId = currentChat.id;
        else payload.recipientId = currentChat.id;

        stompClient.send("/app/chat", {}, JSON.stringify(payload));
        document.getElementById('message-content').value = '';
    }

    // 【【用下面的代码，完整替换你现有的 handleFileUpload 函数】】

    // 【【用下面的代码，完整替换你现有的 handleFileUpload 函数】】

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!currentChat.id) {
            alert("请先选择一个聊天窗口，然后再发送文件。");
            event.target.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/files/upload`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error('文件上传失败');
            const result = await res.json();
            const fileUrl = result.url;

            let content = '';
            const isImage = file.type.startsWith('image/');

            if (isImage) {
                // 【【核心修改】】
                // 如果是图片，生成一个带容器的HTML结构
                // 这个 message-image-container 就是我们的“智能相框”
                content = `
                <div class="message-image-container" onclick="window.open('${fileUrl}')">
                    <img src="${fileUrl}" alt="图片加载中..." />
                </div>
            `;
            } else {
                // 非图片文件保持不变
                content = `<a href="${fileUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--c-primary); text-decoration: underline;">文件: ${file.name}</a>`;
            }

            const payload = {
                senderId: currentUser.id,
                content: content,
                messageType: currentChat.type
            };

            if (currentChat.type === 'GROUP') {
                payload.groupId = currentChat.id;
            } else {
                payload.recipientId = currentChat.id;
            }

            stompClient.send("/app/chat", {}, JSON.stringify(payload));

        } catch (e) {
            alert('操作失败: ' + e.message);
            console.error(e);
        }

        event.target.value = '';
    }

    function renderConversationList(conversations) {
        const list = document.getElementById('conversation-list');
        list.innerHTML = '';
        conversations.forEach(c => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            if (c.type === 'PRIVATE') item.id = `convo-user-${c.id}`;
            item.setAttribute('data-chat-id', c.id);
            item.setAttribute('data-chat-type', c.type);
            item.setAttribute('data-chat-name', c.name);
            item.onclick = () => selectConversation(item);
            let avatarHtml = `<div class="avatar">${c.name.charAt(0).toUpperCase()}</div>`;
            if(c.type === 'PRIVATE' && userCache[c.id] && userCache[c.id].avatarUrl){
                avatarHtml = `<img class="avatar" src="${userCache[c.id].avatarUrl}" alt="${c.name.charAt(0)}">`;
            }
            item.innerHTML = `<div class="avatar-container">${avatarHtml}${c.type === 'PRIVATE' ? '<div class="status-dot offline"></div>' : ''}</div><div class="conversation-details"><span class="conversation-name">${c.name}</span><div class="last-message-content">${c.type === 'GROUP' ? '群聊' : '私聊'}</div></div>`;
            list.appendChild(item);
        });
    }

    function showMessage(message) {
        const msgWindow = document.getElementById('messages-window');
        const row = document.createElement('div');
        // 为消息行增加唯一的ID
        row.id = `message-${message.id}`;
        // 【新增】为消息行增加一个 data-status 属性，用于记录状态
        row.setAttribute('data-status', message.status || 'SENT');
        row.className = `message-row ${message.senderId == currentUser.id ? 'mine' : 'other'}`;

        const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

        let statusIcon = '';
        if (message.senderId == currentUser.id) {
            // 根据用户需求，初始状态的单勾✓也设置为绿色
            statusIcon = `<span id="status-icon-${message.id}" class="message-status-icon sent" style="color: #4ade80;">✓</span>`;
        }

        row.innerHTML = `
        <div class="message-bubble">
            <div class="message-content">${message.content}</div>
            <div style="font-size:11px; text-align:right; margin-top:5px; color:var(--c-text-light);">
                ${time}
                ${statusIcon}
            </div>
        </div>`;

        msgWindow.appendChild(row);
        msgWindow.scrollTop = msgWindow.scrollHeight;
    }

    function startStatusUpdates() {
        if (statusUpdateInterval) clearInterval(statusUpdateInterval);
        updateAllStatuses();
        statusUpdateInterval = setInterval(updateAllStatuses, 10000);
    }

    async function updateAllStatuses() {
        const privateConvoItems = document.querySelectorAll('.conversation-item[data-chat-type="PRIVATE"]');
        if (privateConvoItems.length === 0) return;
        const userIds = Array.from(privateConvoItems).map(item => item.getAttribute('data-chat-id'));
        try {
            const res = await fetchWithAuth(`${GATEWAY_URL}/api/presence/status/batch?userIds=${userIds.join(',')}`);
            const statuses = await res.json();
            for (const userId in statuses) {
                const convoItem = document.getElementById(`convo-user-${userId}`);
                if (convoItem) {
                    const dot = convoItem.querySelector('.status-dot');
                    if(dot) dot.className = `status-dot ${statuses[userId].toLowerCase()}`;
                }
            }
        } catch (e) { console.error("批量更新状态失败:", e); }
    }

    function openNavMenu() {
        const userAvatar = userCache[currentUser.id]?.avatarUrl;
        const navAvatar = document.getElementById('nav-avatar');
        if (userAvatar) {
            navAvatar.innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        } else {
            navAvatar.innerHTML = currentUser.username.charAt(0).toUpperCase();
        }
        document.getElementById('nav-menu').classList.add('open');
        document.getElementById('nav-menu-overlay').style.display = 'flex';
        document.getElementById('nav-username').innerText = currentUser.username;
    }

    function closeNavMenu() {
        document.getElementById('nav-menu').classList.remove('open');
        document.getElementById('nav-menu-overlay').style.display = 'none';
    }

    function handleTyping() {
        if (!stompClient || !currentChat.id) return;
        stompClient.send(`/app/typing/${currentChat.id}`, {}, currentUser.username);
    }

    function showSearchResults() {
        const query = document.getElementById('user-search-bar').value.trim();
        const resultsContainer = document.getElementById('search-results');
        if (query.length > 0 && resultsContainer.children.length > 0) {
            resultsContainer.style.display = 'block';
        }
    }

    function hideSearchResults() {
        setTimeout(() => {
            document.getElementById('search-results').style.display = 'none';
        }, 200);
    }

    function handleUserSearch(event) {
        console.log('【搜索探针 A】handleUserSearch 函数被触发。');
        clearTimeout(searchDebounceTimeout);
        const query = event.target.value.trim();
        const resultsContainer = document.getElementById('search-results');
        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }
        console.log('【搜索探针 B】准备搜索, 关键词:', query);
        searchDebounceTimeout = setTimeout(async () => {
            try {
                const response = await fetchWithAuth(`${GATEWAY_URL}/api/users/search?query=${query}`);
                const users = await response.json();
                console.log('【搜索探针 C】已获取用户数据，准备渲染:', users);
                renderSearchResults(users);
            } catch (error) { console.error("搜索用户失败:", error); }
        }, 500);
    }

    function renderSearchResults(users) {
        console.log('【搜索探针 D】renderSearchResults 被调用，用户数:', users.length);
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        if (users.length === 0) {
            resultsContainer.style.display = 'none';
            return;
        }

        users.forEach(user => {
            if (user.id == currentUser.id) return;
            const item = document.createElement('div');
            item.className = 'search-result-item';

            // 【【核心修改】】
            // 如果当前在群聊中，点击搜索结果是“添加成员”
            // 否则，点击搜索结果是“开始私聊”
            if (currentChat && currentChat.type === 'GROUP') {
                item.onclick = () => addUserToGroup(user);
            } else {
                item.onclick = () => startPrivateChat(user);
            }

            let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
            if (user.avatarUrl) {
                avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
            }
            item.innerHTML = `${avatarHtml}<div style="margin-left: 10px;">${user.username}</div>`;
            resultsContainer.appendChild(item);
        });
        resultsContainer.style.display = 'block';
    }

    /**
     * 【【新增函数】】
     * 调用后端API，将一个用户添加到当前打开的群组中
     * @param {object} user - 要添加的用户对象
     */
    async function addUserToGroup(user) {
        if (!currentChat || currentChat.type !== 'GROUP' || !user) return;

        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members`, {
                method: 'POST',
                body: JSON.stringify({ userId: user.id })
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(errorBody || '添加成员失败');
            }

            alert(`成功将 "${user.username}" 添加到群组!`);
            // 添加成功后，清空搜索框并隐藏结果
            document.getElementById('user-search-bar').value = '';
            document.getElementById('search-results').style.display = 'none';

        } catch (error) {
            alert(`添加失败: ${error.message}`);
            console.error('添加群成员时出错:', error);
        }
    }
    function startPrivateChat(user) {
        hideSearchResults();
        document.getElementById('user-search-bar').value = '';
        let convoExists = false;
        document.querySelectorAll('.conversation-item').forEach(item => {
            if (item.getAttribute('data-chat-id') == user.id && item.getAttribute('data-chat-type') === 'PRIVATE') {
                convoExists = true;
                item.click();
            }
        });
        if (!convoExists) {
            const list = document.getElementById('conversation-list');
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.id = `convo-user-${user.id}`;
            item.setAttribute('data-chat-id', user.id);
            item.setAttribute('data-chat-type', 'PRIVATE');
            item.setAttribute('data-chat-name', user.username);
            item.onclick = () => selectConversation(item);
            let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
            if(user.avatarUrl) {
                avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
            }
            item.innerHTML = `<div class="avatar-container">${avatarHtml}<div class="status-dot offline"></div></div><div class="conversation-details"><span class="conversation-name">${user.username}</span><div class="last-message-content">私聊</div></div>`;
            list.prepend(item);
            item.click();
        }
    }

    function openCreateGroupModal() {
        closeNavMenu();
        document.getElementById('create-group-modal').style.display = 'flex';
    }

    function closeCreateGroupModal() {
        document.getElementById('create-group-modal').style.display = 'none';
        document.getElementById('group-name').value = '';
        document.getElementById('group-description').value = '';
    }

    async function handleCreateGroup() {
        const name = document.getElementById('group-name').value.trim();
        const description = document.getElementById('group-description').value.trim();
        if (!name) { alert('请输入群组名称！'); return; }
        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/create`, {
                method: 'POST',
                body: JSON.stringify({ name, description })
            });
            if (!response.ok) throw new Error(await response.text() || '创建群组失败');
            const newGroup = await response.json();
            alert(`群组 "${newGroup.name}" 创建成功!`);
            closeCreateGroupModal();
            loadAndRenderConversations();
        } catch (error) {
            alert(error.message);
            console.error('创建群组出错:', error);
        }
    }

    function openProfileModal() {
        closeNavMenu();
        const currentUserProfile = userCache[currentUser.id] || currentUser;
        const userAvatar = currentUserProfile.avatarUrl;
        const userBio = currentUserProfile.bio;
        const avatarPreview = document.getElementById('profile-avatar-preview');
        if (userAvatar) {
            avatarPreview.style.display = 'block';
            avatarPreview.src = userAvatar;
        } else {
            avatarPreview.style.display = 'none';
        }
        document.getElementById('profile-bio').value = userBio || '';
        document.getElementById('profile-modal').style.display = 'flex';
    }

    function closeProfileModal() {
        document.getElementById('profile-modal').style.display = 'none';
    }

    async function handleUpdateProfile() {
        const bio = document.getElementById('profile-bio').value;
        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/users/profile`, {
                method: 'PUT',
                body: JSON.stringify({ bio: bio })
            });
            if (!response.ok) throw new Error('更新简介失败');
            const updatedUser = await response.json();
            userCache[currentUser.id] = updatedUser;
            alert('个人资料已更新！');
            closeProfileModal();
        } catch(e) {
            alert(e.message);
            console.error("更新个人资料时出错: ", e);
        }
    }

    /**
     * 【【最终修正版】】
     * 处理收到的用户资料更新事件，并以最安全精确的方式刷新UI
     * @param {object} updatedUser - 从服务器广播过来的、更新后的用户信息对象
     */
    function handleUserUpdate(updatedUser) {
        if (!updatedUser || !updatedUser.id) return;

        // 1. 更新前端的用户信息缓存 (逻辑不变)
        userCache[updatedUser.id] = updatedUser;

        // 2. 【最终重构】更新左侧会话列表中的头像
        const convoItem = document.getElementById(`convo-user-${updatedUser.id}`);
        if (convoItem) {
            const oldAvatarEl = convoItem.querySelector('.avatar'); // 精确找到旧的头像元素
            if (oldAvatarEl) {
                let newAvatarEl;
                if (updatedUser.avatarUrl) {
                    // 方法一：创建全新的 <img> 元素
                    newAvatarEl = document.createElement('img');
                    newAvatarEl.className = 'avatar';
                    newAvatarEl.src = updatedUser.avatarUrl;
                    newAvatarEl.alt = updatedUser.username.charAt(0);
                } else {
                    // 方法二：创建全新的 <div> 元素
                    newAvatarEl = document.createElement('div');
                    newAvatarEl.className = 'avatar';
                    newAvatarEl.textContent = updatedUser.username.charAt(0).toUpperCase();
                }
                // 用创建好的新元素，直接替换掉旧的头像元素
                oldAvatarEl.replaceWith(newAvatarEl);
            }
        }

        // 3. 如果当前正与该用户聊天，则更新聊天窗口顶部的头像 (逻辑不变)
        if (currentChat.id == updatedUser.id) {
            const headerAvatarEl = document.getElementById('chat-header-avatar');
            if (headerAvatarEl) {
                if (updatedUser.avatarUrl) {
                    headerAvatarEl.innerHTML = `<img src="${updatedUser.avatarUrl}" class="avatar">`;
                } else {
                    headerAvatarEl.innerHTML = `<span>${updatedUser.username.charAt(0).toUpperCase()}</span>`;
                }
            }
        }

        // 4. 如果是当前登录用户本人更新了资料，则同步更新左上角菜单里的头像 (逻辑不变)
        if (currentUser.id == updatedUser.id) {
            const navAvatar = document.getElementById('nav-avatar');
            if (navAvatar) {
                if (updatedUser.avatarUrl) {
                    navAvatar.innerHTML = `<img src="${updatedUser.avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    navAvatar.innerHTML = updatedUser.username.charAt(0).toUpperCase();
                }
            }
        }
    }

    function closeViewMembersModal() {
        document.getElementById('view-members-modal').style.display = 'none';
        // 清空上一次的列表，以免下次打开时看到旧数据
        document.getElementById('members-list-container').innerHTML = '';
    }

    /**
     * 【【新增函数】】
     * 获取并显示当前群组的成员列表
     */
    async function showGroupMembers() {
        if (!currentChat || currentChat.type !== 'GROUP') return;

        try {
            // 1. 调用 group-service 获取成员ID列表
            const membersRes = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members`);
            if (!membersRes.ok) throw new Error('获取群成员失败');
            const memberIds = await membersRes.json();

            // 【新增】获取群组的详细信息，我们需要知道谁是群主
            const groupInfoRes = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}`);
            if (!groupInfoRes.ok) throw new Error('获取群组信息失败');
            const groupInfo = await groupInfoRes.json();
            const ownerId = groupInfo.ownerId;

            if (memberIds.length === 0) {
                document.getElementById('members-list-container').innerHTML = '<p>这个群还没有成员。</p>';
            } else {
                // 2. 调用 user-service 批量获取成员的详细信息
                const usersRes = await fetchWithAuth(`${GATEWAY_URL}/api/users/batch?ids=${memberIds.join(',')}`);
                if (!usersRes.ok) throw new Error('获取成员详细信息失败');
                const memberUsers = await usersRes.json();

                // 3. 构建HTML并显示
                const listContainer = document.getElementById('members-list-container');
                listContainer.innerHTML = ''; // 先清空
                memberUsers.forEach(user => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'search-result-item';

                    let avatarHtml = `<div class="avatar">${user.username.charAt(0).toUpperCase()}</div>`;
                    if (user.avatarUrl) {
                        avatarHtml = `<img class="avatar" src="${user.avatarUrl}" alt="${user.username.charAt(0)}">`;
                    }

                    // 【核心修改】判断是否要显示“移除”按钮
                    let removeBtnHtml = '';
                    // 如果当前登录用户是群主，并且列表中的这个成员不是群主自己
                    if (currentUser.id === ownerId && user.id !== ownerId) {
                        removeBtnHtml = `<button class="btn-cancel" style="margin-left: auto;" onclick="removeGroupMember(${user.id}, '${user.username}')">移除</button>`;
                    }

                    memberItem.innerHTML = `${avatarHtml}<div style="margin-left: 10px;">${user.username}</div>${removeBtnHtml}`;
                    listContainer.appendChild(memberItem);
                });
            }

            document.getElementById('view-members-title').innerText = `"${currentChat.name}" 的成员`;
            document.getElementById('view-members-modal').style.display = 'flex';

        } catch (error) {
            alert(error.message);
            console.error('查看群成员时出错:', error);
        }
    }

    /**
     * 【【新增函数】】
     * 调用后端API，从当前群组中移除一个成员
     * @param {number} userIdToRemove - 要被移除的用户ID
     * @param {string} username - 要被移除的用户名，用于提示
     */
    async function removeGroupMember(userIdToRemove, username) {
        if (!confirm(`您确定要将 "${username}" 移出群聊吗？`)) {
            return; // 如果用户点击“取消”，则不执行任何操作
        }

        if (!currentChat || currentChat.type !== 'GROUP') return;

        try {
            const response = await fetchWithAuth(`${GATEWAY_URL}/api/groups/${currentChat.id}/members/${userIdToRemove}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(errorBody || '移除成员失败');
            }

            alert(`已成功将 "${username}" 移出群组。`);

            // 移除成功后，刷新成员列表弹窗
            showGroupMembers();

        } catch (error) {
            alert(`移除失败: ${error.message}`);
            console.error('移除群成员时出错:', error);
        }
    }
</script>
